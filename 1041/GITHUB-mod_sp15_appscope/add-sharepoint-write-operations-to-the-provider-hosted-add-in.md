---
title: プロバイダー向けのホスト型アドインに SharePoint の書き込み操作を追加する
ms.prod: SHAREPOINT
ms.assetid: c3d11afd-098e-4cf9-941e-cca6db28d732
---


# プロバイダー向けのホスト型アドインに SharePoint の書き込み操作を追加する
プロバイダー ホスト型の SharePoint アドイン で SharePoint にデータを書き込む方法を学習 します。
これは、プロバイダー ホスト型 SharePoint アドイン の開発の基本に関する記事のシリーズの 5 番目です。 [SharePoint アドイン](sharepoint-add-ins.md) とこのシリーズの前の記事をよく理解しておいてください。
  
    
    


-  [プロバイダー ホスト型 SharePoint アドインの作成を始める](get-started-creating-provider-hosted-sharepoint-add-ins.md)
    
  
-  [プロバイダー向けのホスト型アドインに SharePoint の外観を付与する](give-your-provider-hosted-add-in-the-sharepoint-look-and-feel.md)
    
  
-  [プロバイダー向けのホスト型アドインにカスタム ボタンを含める](include-a-custom-button-in-the-provider-hosted-add-in.md)
    
  
-  [SharePoint オブジェクト モデルの概要を簡単に説明する](get-a-quick-overview-of-the-sharepoint-object-model.md)
    
  

> **メモ**
> プロバイダー ホスト型アドインに関するこのシリーズを続けて学習している場合は、このトピックを続行するために利用できる Visual Studio ソリューションがあります。また、 [SharePoint_Provider-hosted_Add-Ins_Tutorials](https://github.com/OfficeDev/SharePoint_Provider-hosted_Add-ins_Tutorials) でリポジトリをダウンロードして、BeforeSharePointWriteOps.sln ファイルを開くこともできます。
  
    
    

この記事ではコーディングに戻り、データをチェーンストアの SharePoint アドイン に書き込むいくつかの機能を追加します。
## SharePoint リスト アイテムで列の値を変更する

アドインには、香港ストアの [ **ローカル従業員**] のリストから、企業のデータベースに従業員を追加するカスタムのリボン ボタンがあります。ただし、ユーザーは忘れずに [ **会社の DB に追加済み**] フィールドの値を [はい] に手動で変更する必要があります。それを自動的に実行するコードを追加しましょう。
  
    
    

> **メモ**
>  Visual Studio スタートアップ プロジェクトの設定は、ソリューションを再び開くと既定値に戻ることがよくあります。この記事のシリーズのサンプル ソリューションを再度開く場合は、すぐに次の手順を実行してください。> **ソリューション エクスプローラー**の上部にあるソリューション ノードを右クリックして、[ **スタートアップ プロジェクト**] を選択します。 >  [ **操作**] 列で、3 つのプロジェクトすべてが [ **開始**] に設定されていることを確認します。 
  
    
    


1. **ソリューション エクスプローラー**で、EmployeeAdder.cs ファイルを開きます。
    
  
2. 次の行を、 `AddLocalEmployeeToCorpDB` 呼び出しと **Response.Redirect** 呼び出しの間にある **Page_Load** メソッドに追加します。次の手順で、 `SetLocalEmployeeSyncStatus` メソッドを作成します。
    
 ```cs
  
// Write to SharePoint
SetLocalEmployeeSyncStatus();
 ```

3. 以下の新しいメソッドを  `EmployeeAdder` クラスに追加します。このコードについては以下の点に注目してください。
    
  - [ **Added to Corporate DB (会社の DB に追加済み)**] フィールドの内部名の見た目が不適切です。内部フィールドにはスペースを含めることはできないため、ユーザーが表示名でスペースを使用してフィールドを作成すると、内部名に設定されたときに SharePoint が各スペースを 文字列 "_x0020_" に置き換えます。これにより、[Added to Corporate DB] は [Added_x0020_to_x0020_Corporate_x0020_DB] になります。内部名は 32 文字を超えることができないため、名前は "Added_x0020_to_x0020_Corporate_x" に切り捨てられます。
    
  
  - [ **会社の DB に追加済み**] 列は SharePoint UI では "はい/いいえ (Yes/No)" フィールドと呼ばれますが、実際にはブール値なので、値は [はい (Yes)] ではなく **true** に設定されます。
    
  
  - **ListItem** クラスの **Update** メソッドを呼び出して、変更を SharePoint のコンテンツ データベースにコミットする必要があります。あまり一般的ではありませんが、ここでの全般的な規則として、SharePoint データベースに保存されるオブジェクトのプロパティ値を変更する場合、オブジェクトの **Update** メソッドを呼び出す必要があります。
    
  

 ```cs
  
private void SetLocalEmployeeSyncStatus()
{
    using (var clientContext = spContext.CreateUserClientContextForSPHost())
    {
        List localEmployeesList = clientContext.Web.Lists.GetByTitle("Local Employees");
        ListItem selectedLocalEmployee = localEmployeesList.GetItemById(listItemID);
        selectedLocalEmployee["Added_x0020_to_x0020_Corporate_x"] = true;
        selectedLocalEmployee.Update();
        clientContext.ExecuteQuery();
    }
}
 ```


## ホスト Web リストに書き込むためのアクセス許可の要求

アドインが読み込みだけでなく書き込むようにもなったので、アドインが要求するアクセス許可を読み取りから書き込みに昇格させる必要があります。次の手順を実行します。
  
    
    

1. **ソリューション エクスプローラー**で、 **ChainStore** プロジェクトの AppManifest.xml ファイルを開きます。
    
  
2. [ **アクセス許可**] タブを開き、[ **アクセス許可**] フィールドのドロップダウンから [ **書き込み**] を選択します。
    
  
3. ファイルを保存します。 
    
  

## アドインの実行とボタンのテスト


  
    
    

1. F5 キーを使用して、アドインを展開して実行します。Visual Studio は、IIS Express でリモート Web アプリケーションをホストし、SQL Express で SQL データベースをホストします。これにより、テスト SharePoint サイト上のアドインの一時的なインストールも実行され、アドインもすぐに実行されます。開始ページが表示される前に、アドインへアクセス許可を付与するように求められます。 
    
  
2. アクセス許可のフォームで、リストから [ **ローカル従業員**] を選択し、[ **信頼する**] をクリックします。
    
  
3. アドインの開始ページが開いたら、上部のクロム コントロールにある [ **サイトに戻る**] リンクをクリックします。
    
  
4. Web サイトのホームページから、[ **サイト コンテンツ | ローカル従業員**] に移動します。リスト ビュー ページが開きます。
    
  
5. リストで [ **会社の DB に追加済み**] 列が [ **いいえ**] に設定された従業員がいない場合、従業員をリストに追加し、 *[ **会社の DB に追加済み**] チェック ボックスはオンにしないでください。* 
    
  
6. リボンで、[ **アイテム**] タブを開きます。タブの [ **アクション**] セクションには、カスタム ボタン [ **会社の DB に追加**] があります。
    
  
7. [ **会社の DB に追加済み**] 列が [ **いいえ**] の従業員をリストで選択します。
    
  
8. [ **会社の DB に追加**] ボタンを押します。 * **アイテムを最初に選択しておく必要があります。*** 
    
  
9. ページは EmployeeAdder ページの **Page_Load** メソッドがリダイレクトして戻るため、リロードしているように見えます。従業員の [ **会社の DB に追加済み**] フィールドが [ **はい**] に変更されています。
    
    > **メモ**
      > リストと企業のデータベースの不整合が発生するため、ユーザーが [ **会社の DB に追加済み**] の値を手動で変更できないようにするのは何でしょうか？今のところ何もその処理を行っていません。この問題の解決策は、このシリーズの後の記事で説明します。 
10. デバッグ セッションを終了するには、ブラウザー ウィンドウを閉じるか、Visual Studio でデバッグを停止します。F5 を押すたびに、Visual Studio は以前のバージョンのアドインを取り消し、最新のアドインをインストールします。
    
  
11. **ソリューション エクスプローラー**のプロジェクトを右クリックして、[ **取り消し**] を選択します。
    
  

## ホスト Web サイトで新しいカスタム リストを作成する

チェーンストア アドインで次に改善する点は、既存のアイテムのフィールドをただ変更する代わりに、リストに新しいアイテムを作成することです。特に、新しい受注が企業レベルで行われる場合、ローカル従業員に出荷を予想するよう通知するアイテムが SharePoint のリストに自動的に作成されます。リストは [ **予想される出荷**] という名前で、以下の手順で作成します。このシリーズの後の記事で、ホストの Web サイトにカスタム リストをプログラムで追加する方法を説明しますが、現段階では手動で作成します。 
  
    
    

1. Fabrikam Hong Kong ストアから、[ **サイト コンテンツ | アドインの追加 | カスタム リスト**] に移動します。 
    
  
2. [ **カスタムリストの追加中**] ダイアログで、[予想される出荷] を名前として表示するよう指定し、[ **作成**] を押します。 
    
  
3. [ **サイト コンテンツ**] ページで、[ **予想される出荷**] リストを開きます。
    
  
4. リボンの [ **リスト**] タブを開き、[ **リストの設定**] ボタンをクリックします。
    
  
5. [ **リストの設定**] ページの [ **列**] セクションで、[ **タイトル**] 列をクリックします。 
    
  
6. [ **列の編集**] フォームで、[ **列名**] を [タイトル] から [製品] に変更して、[ **OK**] をクリックします。
    
  
7. [ **設定**] ページで、[ **列の作成**] をクリックします。
    
  
8. このシリーズの前の記事で、リストのカスタム列を作成する方法について説明しました。[ **予想される出荷**] リストで、次の表の値を使用し、4 つの列を追加します。その他の設定は既定値のままにしておきます。
    

|**列名**|**データ型**|**必須かどうか**|**既定値**|
|:-----|:-----|:-----|:-----|
|メーカー <br/> |**1 行テキスト** <br/> |必須でない  <br/> |なし  <br/> |
|数量 <br/> |**数値** <br/> |必須  <br/> |1 <br/> |
|到着済み <br/> |**はい/いいえ** <br/> |必須でない  <br/> |いいえ <br/> |
|在庫に追加済み <br/> |**はい/いいえ** <br/> |必須でない  <br/> |いいえ <br/> |
   
9. 列を作成した後で、リストの設定ページで、[ **サイト コンテンツ**] をクリックして、[ **サイト コンテンツ**] ページを開きます。[ **予想される出荷**] リストを開きます。
    
  
10. [ **新しいアイテム**] をクリックします。アイテム作成フォームは、必須フィールドであることを示す 2 つのアスタリスクを含め、以下とまったく同じになります。
    
!\[[予想される出荷] 一覧のアイテム作成フォームです。[製品]、[仕入先]、[数量]、[到着済み]、[在庫に追加済み] のフィールドがあります。[製品] と [数量] のタイトルの横にはアスタリスクが表示されており、[数量] には既定値の 1 が表示されています。](images/e552b5c9-8baa-4e53-9295-4d85a79d7734.PNG)
  

  

  
11. このリストのアイテムを手動で作成したくないので、[ **キャンセル**] をクリックします。
    
  

## アイテムを SharePoint リストに挿入する

アドインに、香港ストアの受注が企業レベルで追加されたときに必ず [ **予想される出荷**] リストにアイテムを作成する関数を追加しました。
  
    
    

1. **ソリューション エクスプローラー**で、OrderForm.aspx.cs ファイルを開きます。
    
  
2. **Microsoft.SharePoint.Client** の **using** ステートメントをファイルの先頭に追加します。
    
  
3.  `btnCreateOrder_Click` メソッドで、次の行を `CreateOrder` への呼び出しのすぐ下に追加します。次の手順では、CreateExpectedShipment メソッドを作成します。
    
 ```cs
  
CreateExpectedShipment(txtBoxSupplier.Text, txtBoxItemName.Text, quantity);
 ```

4. 以下のメソッドを  `OrderForm` クラスに追加します。このコードについては以下の点に注目してください。
    
  - **ListItem** オブジェクトはコンストラクターを使用して作成されません。これはパフォーマンス上の理由によるものです。 **ListItem** オブジェクトには、(既定値を持つ) 多数のプロパティがあります。コンストラクターが使用される場合、 **ExecuteQuery** メソッドがサーバーに送信する XML メッセージにオブジェクト全体が含まれることになります。 **ListItemCreationInformation** オブジェクトは、サーバーが **ListItem** オブジェクトの作成に必要とする既定以外の最小の値のみを含む軽量オブジェクトです。 **ListItem** オブジェクトを作成する行があるように見えますが、この行は、サーバーに送信されるメッセージにいくつかの XML マークアップを追加するだけであることを思い出してください。 **ListItem** オブジェクトが、サーバー上で作成されます。
    
  
  - **ListItem** オブジェクトをクライアントに戻す必要はないため、 **ClientContext.Load** メソッドの呼び出しは行われません。
    
  
  - コードで明示的に [ **到着済み**] または [ **在庫に追加済み**] フィールドを設定する必要はありません。これは、既定値が [いいえ] であり、これがここで必要な設定であるためです。
    
  

 ```
  private void CreateExpectedShipment(string supplier, string product, UInt16 quantity)
{
    using (var clientContext = spContext.CreateUserClientContextForSPHost())
    {
        List expectedShipmentsList = clientContext.Web.Lists.GetByTitle("Expected Shipments");
        ListItemCreationInformation itemCreateInfo = new ListItemCreationInformation();
        ListItem newItem = expectedShipmentsList.AddItem(itemCreateInfo);
        newItem["Title"] = product;
        newItem["Supplier"] = supplier;
        newItem["Quantity"] = quantity;
        newItem.Update();
        clientContext.ExecuteQuery();
    }
}
 ```


## 削除されたコンポーネントのチェック

SharePoint リストのリスト所有者権限を持つユーザーは、だれでもリストを削除できます。また、リストがアドインによってホスト Web に配置された場合、ホスト Web の Web サイトの所有者が削除できます。所有者がリストにより提供される機能を使わずに削除することにした場合に、こういったことが発生することがあります。(所有者が考えを変えた場合、SharePoint のごみ箱から復元できます。) 
  
    
    
 `CreateExpectedShipment` メソッドは、[ **予想される出荷**] リストの存在に依存します。Web サイトの所有者がリストの削除を決定したとします。その後、アドインの [ **受注フォーム**] を使用して受注が追加されると、 `CreateExpectedShipment` が呼び出されて例外がスローされ、SharePoint Web サイトに [ **予想される出荷**] リストがないことを示すメッセージが表示されます。 
  
    
    
 `expectedShipmentsList` がヌルかどうかについて、処理を行う前にメソッドで確認することをお勧めします。CSOM を使用して作業している場合、次のようなシンプルな構造ではこのチェックを行うことは *できません*  。
  
    
    
 `if (expectedShipmentsList != null) { ... }`
  
    
    
代わりに、 **ConditionalScope** という特別な CSOM クラスを使用する必要があります。これは、CSOM のバッチ処理システムに接続されているためであり、このシリーズの前の記事で説明しています。( [クライアント側のランタイムとバッチ処理](get-a-quick-overview-of-the-sharepoint-object-model.md#CSOMBatching)を参照。) **ConditionalScope** およびバッチ処理システムは、この基礎知識シリーズの範囲外である高度なトピックですが、チュートリアルのこのシリーズを完了した後で、MSDN のそれらに関するドキュメントをご覧になることをお勧めします。
  
    
    
リストの存在を確認する別の方法があります。 **GetByTitle** メソッドを使用してリストへの参照を取得する代わりに、次のようなコードを使用して、指定された名前のリストが、Web サイトの「リストのリスト」にあるか確認できます。
  
    
    


```cs

var query = from list in clientContext.Web.Lists
             where list.Title == "Expected Shipments" 
             select list; 
IEnumerable<List> matchingLists = clientContext.LoadQuery(query); 
clientContext.ExecuteQuery(); 
if (matchingLists.Count() != 0) 
{ 
    List expectedShipmentsList = matchingLists.Single(); 
    // Do something with the list. 
}
clientContext.ExecuteQuery(); ```

前のコードには、 **ConditionalScope** クラスの複雑化を回避できるメリットがあり、このシリーズの記事ではどこでもこのコードをそのまま使用します。ただし、デメリットもあります。このコードでは **if** ステートメントで確認する値を取得するためだけに、 **ExecuteQuery** を追加で呼び出す必要があります。このテクニックを `CreateExpectedShipment` で使用してリストの存在を確認する場合、メソッドは **ExecuteQuery** を 2回呼び出し、それぞれがリモート Web サーバーから SharePoint への HTTP 要求を行います。これらの要求は CSOM メソッドで最も時間がかかる部分であるため、通常は最小限にすることをお勧めします。
  
    
    
 `CreateExpectedShipment` はそのままにしますが、運用アドインでは、参照先のコンポーネントが削除される場合に、コードがどのように機能するか考慮する必要があります。ごみ箱からリストをプログラムによって復元するのも 1 つのオプションですが、これはリストの削除を意図的に行うことにしたユーザーを困らせます。また、例外を回避するために何もしないことが最善である可能性も考慮する必要があります。SharePoint からの例外は、リストを削除するとアドインの一部が壊れることをユーザーに警告しますが、削除を行ったユーザーはこのことを認識していない可能性があります。次に、ユーザーはごみ箱からリストを復元するか、または機能しなくなった部分抜きでアドインを実行するかを決定できます。
  
    
    

## Web サイトを管理するためのアクセス許可の要求

アドインがスコープがリストの読み込みまたは書き込み権限を要求した場合、SharePoint がユーザーにアドインを信頼するか確認するプロンプトを表示しますが、そのダイアログにはアドインがアクセスするリストをユーザーが選択するドロップダウンリストが含まれます。選択できるのは 1 つのリストのみです。ただし、チェーンストア アドインは、2 つの異なるリストに書き込みを行います。複数のリストへのアクセス権を取得するには、アドインはスコープが Web のアクセス許可を要求する必要があります。次の手順を実行します。
  
    
    

1. **ソリューション エクスプローラー**で、 **ChainStore** プロジェクトの AppManifest.xml ファイルを開きます。
    
  
2. [ **アクセス許可**] タブを開き、[ **スコープ**] フィールドのドロップダウンから [ **Web**] を選択します。
    
  
3. [ **アクセス許可**] フィールドで、ドロップダウンから [ **書き込み**] を選択します。
    
  
4. ファイルを保存します。 
    
  

## アドインの実行とアイテムの作成のテスト


  
    
    

1. F5 キーを使用して、アドインを展開して実行します。Visual Studio は、IIS Express でリモート Web アプリケーションをホストし、SQL Express で SQL データベースをホストします。これにより、テスト SharePoint サイト上のアドインの一時的なインストールも実行され、アドインもすぐに実行されます。開始ページが表示される前に、アドインへアクセス許可を付与するように求められます。 
    
  
2. アドインの開始ページが開いたら、ページの下部にある [ **受注**] フォームのリンク をクリックします。 
    
  
3. フォームでいくつかの値を入力して、[ **注文**] を押します。
    
  
4. ブラウザーの [戻る] ボタンを使用して開始ページに移動し、上部にあるクロム コントロールで [ **サイトに戻る**] をクリックします。
    
  
5. 香港ストアのホーム ページから、[ **サイト コンテンツ**] に移動して [ **予想される出荷**] リストを開きます。受注に対応するリストのアイテムが含まれるようになっています。次のスクリーンショットが一例です。
    
!\[[予想される出荷] 一覧にアイテムが 1 つ表示されています。その [製品] フィールドと [仕入先] フィールドには名前が入っています。[数量] フィールドには数字が入っています。2 つの [はい/いいえ] フィールドはどちらも [いいえ] に設定されています。](images/e4285084-d31e-4e79-a469-ddebbc7dfb18.PNG)
  

  

  
6. デバッグ セッションを終了するには、ブラウザー ウィンドウを閉じるか、Visual Studio でデバッグを停止します。F5 を押すたびに、Visual Studio は以前のバージョンのアドインを取り消し、最新のアドインをインストールします。
    
  
7. **ソリューション エクスプローラー**のプロジェクトを右クリックして、[ **取り消し**] を選択します。
    
  

## 
<a name="Nextsteps"> </a>

 次の記事では、SharePoint ページでリモートの受注フォームを Web パーツとして表示する方法を説明します。 [プロバイダー向けのホスト型アドインにアドインの一部を含める](include-an-add-in-part-in-the-provider-hosted-add-in.md)
  
    
    

