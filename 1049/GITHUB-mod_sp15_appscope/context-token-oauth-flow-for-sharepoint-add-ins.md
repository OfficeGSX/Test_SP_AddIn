---
title: Поток маркеров контекста OAuth для надстроек в SharePoint
ms.prod: SHAREPOINT
ms.assetid: 526c8c4a-5cbb-4efc-87d9-23ac73655cf4
---


# Поток маркеров контекста OAuth для надстроек в SharePoint
Сведения о потоке аутентификации и авторизации по протоколу OAuth для размещаемых у поставщика надстроек с низким уровнем доверия в SharePoint.
## OAuth и размещаемые у поставщика Надстройки SharePointSharePoint
<a name="OAuth_Actors"> </a>

В SharePoint **поток проверки подлинности и авторизации по протоколу OAuth для размещаемой у поставщика надстройки с низким уровнем доверия включает ряд операций взаимодействия между надстройкой, SharePoint, сервером авторизации и браузером** во время выполнения. В качестве сервера авторизации в этом случае выступает служба Служба контроля доступа Microsoft Azure (ACS).
  
    
    
Размещаемая у поставщика надстройка представляет собой удаленное веб-приложение или службу, отдельные от SharePoint и не входящие в состав фермы SharePoint или клиента SharePoint Online. Она может быть размещена в облаке или на локальном сервере. В этой статье удаленный компонент называется Contoso.com.
  
    
    

> [!Примечание]
> В удаленном компоненте также могут размещаться приемники событий, реагирующие на события, которые происходят с элементами SharePoint, такими как списки или элементы списков. Примерами удаленных событий, на которые может реагировать Contoso.com, являются события списков, например добавление или удаление элемента списка, а также веб-события, например добавление или удаление сайта. Подробнее о создании приемников удаленных событий см. в разделе  [Создание удаленного приемника событий в надстройках SharePoint](create-a-remote-event-receiver-in-sharepoint-add-ins.md). 
  
    
    

В Contoso.com используется клиентская объектная модель (CSOM) SharePoint или интерфейсы REST API SharePoint для вызовов SharePoint. В приложении Contoso.com для аутентификации SharePoint используется поток обработки маркеров OAuth. **SharePoint и Contoso.com не являются доверенными между собой, но доверяют ACS** и принимают маркеры, выданные ACS. При этом используется три маркера: SharePoint запрашивает у ACS создание маркера контекста, который пересылается SharePoint в Constoso.com. Contoso.com проверяет, выдан ли маркер контекста ACS, чтобы доверять ему. Затем Contoso.com извлекает маркер обновления из маркера контекста и использует его для получения маркера доступа непосредственно от ACS. Он включает маркер доступа во всех своих запросах в SharePoint. SharePoint проверяет, выдан ли маркер доступа ACS, чтобы отвечать на запросы от Contoso.com.
  
    
    
В удаленном компоненте **указывается код обработки маркеров**. (Но если ваш удаленный компонент размещен в .NET, Инструменты разработчика Microsoft Office для Visual Studio предоставляют пример кода, который выполняет за вас основную часть работы.) Подробнее о коде обработки маркеров см. в статье [Обработка маркеров безопасности в надстройках с низким уровнем доверия для SharePoint, размещаемых у поставщика](handle-security-tokens-in-provider-hosted-low-trust-sharepoint-add-ins.md).
  
    
    

## Необходимые условия для использования потока
<a name="Prerequisites"> </a>

Ниже описаны некоторые предварительные действия, которые необходимо выполнить, чтобы Надстройка SharePoint смогло использовать поток маркеров контекста. 
  
    
    

- Если Надстройка SharePoint устанавливается в локальной ферме SharePoint, некоторые требования к установке не применяются для приложений, устанавливаемых только в SharePoint Online.
    
  - **Необходимо настроить ферму** для поддержки надстроек. (На самом деле, это требуется, когда в ферме устанавливаются любые Надстройки SharePoint, даже не использующие поток маркеров контекста). Дополнительные сведения см. в статье [Настройка среды надстроек SharePoint](http://technet.microsoft.com/ru-ru/library/fp161236%28v=office.15%29.aspx).
    
  
  - У **клиента**, устанавливающего надстройку, **должна быть учетная запись Office 365**. Это требуется для получения доступа к ACS. Клиент может не использовать свою учетную запись для других целей.
    
  
  - Ферму необходимо настроить для совместного использования отношения доверия Office 365 к ACS. Это можно легко сделать с помощью скриптов Windows PowerShell. Подробнее см. в статье  [Использование сайта Office 365 SharePoint для авторизации размещенных у поставщика надстроек на локальном сайте SharePoint](use-an-office-365-sharepoint-site-to-authorize-provider-hosted-add-ins-on-an-on.md).
    
  
- Независимо от того, где установлена надстройка: в SharePoint Online или в локальной ферме SharePoint, необходимо зарегистрировать **Надстройка SharePoint в ACS**. Дополнительные сведения о том, как это можно сделать, см. в статье [Регистрация надстроек для SharePoint 2013](register-sharepoint-add-ins-2013.md). Кроме прочего, в ходе регистрации надстройка предоставляет ACS свой идентификатор и секрет клиента.
    
  

## Этапы потока маркеров контекста
<a name="OAuth_ProcessFlowSteps"> </a>

Процесс аутентификации и авторизации по протоколу OAuth для надстройки SharePoint, размещаемой у поставщика, показан на следующем рисунке.
  
    
    

**Поток маркеров контекста OAuth**

  
    
    

  
    
    
![Процесс авторизации OAuth](images/833fcdcc-1755-438b-9ada-dce9646564c0.gif)
  
    
    
Вот этапы, соответствующие номерам на рисунке.
  
    
    

  
    
    

1. Пользователь запускает Надстройка SharePoint из SharePoint. Способ запуска зависит от того, как спроектирована надстройка.
    
  - Если надстройка получает доступ к удаленному веб-приложению (в Contoso.com) в веб-части надстройки (по сути, представляющей собой оболочку вокруг **IFRAME**), запуск надстройки означает только переход на страницу SharePoint, содержащую веб-часть надстройки. Если пользователь еще не вошел в систему, SharePoint предлагает это сделать. SharePoint обрабатывает страницу и обнаруживает, что на ней есть компонент из надстройки Contoso.com. (Дополнительные сведения о веб-частях надстроек см. в статье  [Создание веб-частей надстройки для установки совместно с надстройкой для SharePoint](create-add-in-parts-to-install-with-your-sharepoint-add-in.md).)
    
  
  - Если надстройка использует полную страницу в браузере, пользователь запускает ее, нажимая соответствующую плитку надстройки на странице **Site Contents** веб-сайта SharePoint. (Надстройка также может включать настраиваемое меню или элемент ленты, запускающий удаленный компонент.)
    
  
2. Независимо от того, как запускается надстройка, среде SharePoint требуется получить маркер контекста, который она может отправить приложению Contoso.com. Поэтому она посылает запрос в ACS на создание маркера контекста, содержащего сведения о контексте SharePoint, в том числе о текущем пользователе и URL-адресе удаленного приложения, а также другую информацию. Маркер контекста также содержит зашифрованный маркер обновления.
    
  
3. ACS подписывает маркер контекста с помощью алгоритма, использующего секрет надстройки Contoso.com, и возвращает его в SharePoint. Этот секрет знают только ACS и надстройка Contoso.com.
    
  
4. Если надстройка Contoso.com доступна в веб-части надстройки, SharePoint обрабатывает страницу, на которой она размещена, и добавляет маркер контекста в URL-адрес, вызываемый **IFRAME** в веб-части надстройки, чтобы получить ее контент. Если надстройка Contoso.com представляет собой полную страницу, SharePoint перенаправляет браузер в Constoso.com и включает маркер контекста в ответ перенаправления.
    
  
5. В запрос браузера, отправляемый на сервер Contoso.com, включается маркер контекста.
    
  
6. Сервер Contoso.com получает маркер контекста и проверяет подпись, зная секрет клиента. Таким образом Contoso.com получает подтверждение, что маркер выдан ACS, а не мошенническим сайтом, выдающим себя за SharePoint. Contoso.com извлекает маркер обновления из маркера контекста и отправляет его ACS вместе с другой информацией, включая идентификатор и секрет клиента, в запросе маркера доступа к SharePoint.
    
  
7. ACS проверяет, выдан ли маркер обновления нею, а затем возвращает маркер доступа Contoso.com. Кроме того, Contoso.com может кэшировать этот маркер доступа, чтобы не запрашивать его у ACS при каждом доступе к SharePoint. По умолчанию маркер доступа остается действительным в течение нескольких часов. (На момент написания данной статьи срок действия маркеров доступа, выдаваемых ACS SharePoint, составлял 12 часов, но это значение могло измениться.) Каждый маркер доступа связан с учетной записью пользователя, указанной в исходном запросе на авторизацию, и предоставляет доступ только к той службе (в данном случае SharePoint), которая указана в запросе. Маркеры обновления действуют дольше (шесть месяцев на момент написания) и также могут кэшироваться. Поэтому для получения нового маркера доступа от ACS можно использовать исходный маркер обновления, пока не истечет срок действия самого маркера обновления. (Подробнее о кэшировании маркеров см. в статье  [Обработка маркеров безопасности в надстройках с низким уровнем доверия для SharePoint, размещаемых у поставщика](handle-security-tokens-in-provider-hosted-low-trust-sharepoint-add-ins.md).) Когда истекает срок действия маркера обновления, Contoso.com может получить новый, получив для этого новый маркер контекста. Подробнее о том, как это делается, см. в статье  [Получение нового маркера контекста](handle-security-tokens-in-provider-hosted-low-trust-sharepoint-add-ins.md#GetNewContextToken).
    
  
8. Contoso.com использует маркер доступа для вызова SharePoint REST API или отправки запроса CSOM к spnv. Для этого маркер доступа OAuth передается в заголовке HTTP **Authorization**. (Если удаленный компонент размещен на платформе .NET, Инструменты разработчика Office для Visual Studio содержат пример кода для создания заголовка).
    
  
9. SharePoint проверяет, выдан ли маркер доступа ACS, а затем отправляет в приложение Contoso.com запрошенные им данные или выполняет операцию создания, чтения, обновления или удаления (CRUD), запрошенную Contoso.com.
    
  
10. Страница надстройки Contoso.com преобразовывается для просмотра в браузере (или в **IFRAME** веб-части надстройки).
    
  

## Дополнительные ресурсы
<a name="Filename_AdditionalResources"> </a>


-  [Авторизация и проверка подлинности для надстроек в SharePoint 2013](authorization-and-authentication-of-sharepoint-add-ins.md)
    
  
-  [Разрешения для надстроек в SharePoint 2013](add-in-permissions-in-sharepoint-2013.md)
    
  
-  [Важные аспекты архитектуры и разработки надстройки SharePoint](important-aspects-of-the-sharepoint-add-in-architecture-and-development-landscap.md)
    
  
-  [Знакомство с созданием надстроек SharePoint с размещением в SharePoint](get-started-creating-sharepoint-hosted-sharepoint-add-ins.md)
    
  

