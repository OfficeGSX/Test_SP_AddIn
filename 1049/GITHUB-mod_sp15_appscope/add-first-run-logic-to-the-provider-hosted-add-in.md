---
title: Добавление кода, выполняемого при первом запуске, в надстройку, размещаемую у поставщика
ms.prod: SHAREPOINT
ms.assetid: 649c06b9-3612-439a-acb3-041e5f5f01f3
---


# Добавление кода, выполняемого при первом запуске, в надстройку, размещаемую у поставщика
В данной статье рассказано, как включить код, выполняемый при первом запуске, в надстройку SharePoint, размещаемую у поставщика.
Это восьмая часть из серии статей о том, как разрабатывать Надстройки SharePoint, размещаемые в у поставщика. Сначала вам необходимо ознакомиться со статьей  [Надстройки SharePoint](sharepoint-add-ins.md) и с указанными ниже предыдущими статьями серии.





-  [Знакомство с созданием надстроек SharePoint с размещением у поставщика](get-started-creating-provider-hosted-sharepoint-add-ins.md)


-  [Придание надстройке, размещаемой у поставщика, внешнего вида и удобства использования SharePoint](give-your-provider-hosted-add-in-the-sharepoint-look-and-feel.md)


-  [Включение настраиваемой кнопки в надстройку, размещаемую у поставщика](include-a-custom-button-in-the-provider-hosted-add-in.md)


-  [Краткий обзор объектной модели SharePoint](get-a-quick-overview-of-the-sharepoint-object-model.md)


-  [Добавление операций записи SharePoint в надстройку, размещаемую у поставщика](add-sharepoint-write-operations-to-the-provider-hosted-add-in.md)


-  [Включение веб-части надстройки в надстройку, размещаемую у поставщика](include-an-add-in-part-in-the-provider-hosted-add-in.md)


-  [Обработка событий надстройки в надстройке, размещаемой у поставщика](handle-add-in-events-in-the-provider-hosted-add-in.md)



> **Примечание**
> Если вы изучали предыдущие статьи этой серии о надстройках, размещаемых в SharePoint, то у вас уже есть решение для Visual Studio, которое можно использовать для работы с данной статьей. Кроме того, вы можете скачать репозиторий  [SharePoint_SP-hosted_Add-Ins_Tutorials](https://github.com/OfficeDev/SharePoint_SP-hosted_Add-Ins_Tutorials) и открыть файл BeforeFirstRunLogic.sln.




В этой статье показано добавление на начальную страницу в надстройке Chain Store (надстройке SharePoint) такого кода, который проверяет, первый ли это запуск текущего экземпляра надстройки. Если это первый запуск надстройки, код развернет список **Local Employees** (Местные сотрудники) и настраиваемую кнопку ленты.
## Создание базового класса для развертывания компонентов SharePoint






> **Примечание**
>  При повторном открытии решения параметры раздела "Начальные проекты" в Visual Studio обычно сбрасываются к значениям, используемым по умолчанию. Сразу же после повторного открытия примера решения в этой серии статей всегда выполняйте указанные ниже действия.>  В верхней части **обозревателя решений** щелкните правой кнопкой мыши узел решения и выберите **Назначить запускаемые проекты**. >  Убедитесь, что в столбце **Действие** для всех трех проектов указано значение **Запускать**. 





1. В проекте **ChainStoreWeb** в **обозревателе решений** щелкните правой кнопкой мыши папку **Utilities** и выберите пункт **Добавить | Существующий элемент**.


2. В открывшемся **проводнике** перейдите в папку решения ( **ChainStoreWeb**), а затем откройте папку **Utilities**.


3. Выберите файл SharePointComponentDeployer.cs и нажмите кнопку **Добавить**.


4. Откройте файл SharePointComponentDeployer.cs. В нем есть статический класс и два статических метода, которые получают и задают версию надстройки в таблице **Tenants** (Клиенты) корпоративной базы данных. Мы не будем рассматривать эти методы, так как эта серия статей не предназначена для обучения программированию для ASP.NET или SQL Server/Azure.


5. Добавьте указанные ниже операторы **using** в начало файла.

 ```

using System.Web;
using System.Linq;
using System.Collections.Generic;
using Microsoft.SharePoint.Client;
 ```

6. В начале класса  `SharePointComponentDeployer` добавьте два указанных ниже статических поля. Инициализация обеих полей будет выполняться в методе **Page_Load** начальной страницы надстройки. Вы добавите этот код на одном из следующих этапов. В первом поле будет храниться объект **SharePointContext**, необходимый для выполнения операций CRUD в SharePoint. Во втором поле  номер версии надстройки, установленной на хост-сайте. Изначально (когда обработчик установки регистрирует клиент) это значение будет отличаться от значения, используемого по умолчанию ( **0000.0000.0000.0000** ) и записанного в корпоративной таблице **Tenants** (Клиенты). Например, номер первой версии надстройки будет выглядеть следующим образом: **1.0.0.0**.

 ```cs

internal static SharePointContext sPContext;
internal static Version localVersion;
 ```

7. Создайте указанное ниже статическое свойство, в котором будет храниться номер версии надстройки, которая в текущий момент зарегистрирована в корпоративной таблице **Tenants** (Клиенты). Для получения и задания этого значения оно использует два метода, которые уже имелись в файле.

 ```cs

internal static Version RemoteTenantVersion
{
    get
    {
        return GetTenantVersion();
    }
    set
    {
        SetTenantVersion(value);
    }
}
 ```

8. Теперь создайте указанное ниже свойство  `IsDeployed`. Обратите внимание на указанные ниже особенности этого кода.

  - Метод **Page_Load** начальной страницы надстройки будет использовать значение этого свойства, чтобы определить, первый ли это запуск надстройки. Значение **false** сигнализирует, что надстройку раньше не запускали, поэтому необходимо развернуть ее компоненты.


  - Критерием проверки является то, меньше ли номер версии, зарегистрированный в таблице **Tenants** (Клиенты), чем номер установленной версии. При первом запуске надстройки он будет меньше. Код, который вы напишете на одном из следующих этапов, задает в таблице **Tenants** (Клиенты) номер фактически установленной версии, поэтому при повторном запуске надстройки метод `IsDeployed` возвратит значение **true**, что позволит предотвратить повторное выполнение кода, отвечающего за развертывание.



 ```cs

public static bool IsDeployed
{
    get
    {
        if (RemoteTenantVersion < localVersion)
            return false; 
        else
            return true; 
    }
}
 ```

9. Добавьте указанный ниже метод в класс  `SharePointComponentDeployer`. Обратите внимание, что последнее, что делает метод,  обновляет версию зарегистрированного клиента в базе данных предприятия ( **0000.0000.0000.0000** ), чтобы она соответствовала фактической версии надстройки на хост-сайте ( **1.0.0.0** ). Вы закончите этот метод на одном из следующих этапов.

 ```cs

internal static void DeployChainStoreComponentsToHostWeb(HttpRequest request)
{
    // TODO4: Deployment code goes here.

    RemoteTenantVersion = localVersion;
}
 ```


> **Примечание**
> Вас может озадачить, почему надстройка использует номера версий и проверку с условием "меньше, чем", чтобы получить простой ответ "да" или "нет" на вопрос "первый ли это запуск надстройки?". Мы могли бы использовать простое строковое поле в таблице **Tenants** (Клиенты). Обработчик установки присваивал бы этому полю значение "ни разу не была запущена", а после развертывания компонентов SharePoint код, отвечающий за первый запуск, изменял бы это значение на "была запущена один раз".> Для надстройки Chain Store простая проверка работала бы. Тем не менее в общем случае рекомендуется использовать номера версий. Это связано с тем, что в будущем надстройки, используемые в рабочей среде, скорее всего будут обновляться "на месте", то есть уже после их установки. В этом случае коду надстройки будет недостаточно двух вариантов ни разу не была запущена ибыла запущена один раз. Предположим, что при обновлении надстройки с версии 1.0.0.0 до версии 2.0.0.0 вы хотите добавить дополнительный список на хост-сайт. Вы могли бы сделать это в обработчике событий обновления или в коде, выполняемом во при первом запуске после обновления. В любом случае коду, выполняемому при развертывании, потребуется развернуть новые компоненты. Кроме того, ему потребуется не развертывать компоненты, которые были развернуты в предыдущей версии надстройки. Номер версии 1.0.0.0 станет сигналом, что компоненты версии 1.0.0.0 уже развернуты, но код, выполняемый при первом запуске после обновления, еще не был запущен. 





## Добавление базового кода, выполняемого при запуске






1. Хост-сайту SharePoint необходимо сообщить удаленному веб-приложению номер версии установленной им надстройки. Для этого мы используем параметр запроса. Откройте файл AppManifest.xml в проекте **ChainStore**. В конструкторе вы увидите, что в качестве значения поля **Query string** (Строка запроса) используется заполнитель **{StandardTokens}**. Добавьте строку &amp;SPAddInVersion=1.0.0.0 в конец файла. Конструктор манифеста должен выглядеть примерно так, как показано ниже. *Обратите внимание, что номер версии, который вы передаете в строке запроса, должен совпадать со значением в поле **Version** (Версия) в конструкторе.*  (Если вы когда-либо будете обновлять надстройку, вам потребуется сделать так, чтобы эти два значения стали одинаковыми.)

!\[Вкладка "Общие" в конструкторе манифеста. Поле "Версия" содержит значение "один ноль ноль ноль". Поле "Строка запроса" содержит текст "{StandardTokens}&amp;SPAddInVersion=1.0.0.0"](images/db71c411-10c5-43d8-bb5e-3388d2f6f7bc.PNG)





2. Откройте файл CorporateDataViewer.aspx.cs и добавьте указанный ниже код в метод **Page_Load** сразу же после строки, в которой выполняется инициализация объекта `spContext`. Обратите внимание на указанные ниже особенности этого кода.

  - Он начинается с задания двух статических полей в статическом классе  `SharePointComponentDeployer`. Он передает объект **SharePointContext**, так как код в  `SharePointComponentDeployer` будет вызываться в SharePoint, и использует параметр запроса, который вы добавили, чтобы задать свойство `localVersion`.


  - Он ничего не делает, если  `IsDeployed` имеет значение true, то есть если код, выполняемый при первом запуске, уже был запущен. В противном случае он вызывает метод развертывания и передает объект запроса ASP.NET.



 ```cs

SharePointComponentDeployer.sPContext = spContext;
SharePointComponentDeployer.localVersion = new Version(Request.QueryString["SPAddInVersion"]);

if (!SharePointComponentDeployer.IsDeployed)
{
    SharePointComponentDeployer.DeployChainStoreComponentsToHostWeb(Request);
}
 ```


## Программное развертывание списка SharePoint






1. В файле SharePointComponentDeployer.cs замените  `TODO4` указанной ниже строкой. Вы создадите этот метод на следующем этапе.

 ```cs

CreateLocalEmployeesList();
 ```

2. Добавьте указанный ниже метод в класс  `SharePointComponentDeployer`. Обратите внимание на указанные ниже особенности этого кода.

  - В нем имеется два вызова **ExecuteQuery**. Первый необходим, чтобы определить, существует ли список. Второй выполняет действия, необходимые для создания списка.


  - Метод **ClientContext.LoadQuery** похож на метод **ClientContext.Load** за исключением того, что вместо передачи объекта, например списка, клиенту, он передает перечислимые результаты запроса.



 ```cs
  private static void CreateLocalEmployeesList()
{
    using (var clientContext = sPContext.CreateUserClientContextForSPHost())
    {
        var query = from list in clientContext.Web.Lists
                    where list.Title == "Local Employees"
                    select list;
        IEnumerable<List> matchingLists = clientContext.LoadQuery(query);
        clientContext.ExecuteQuery();

        if (matchingLists.Count() == 0)
        {
           // TODO5: Create the list 

           // TODO6: Rename the Title field on the list 

           // TODO7: Add "Added to Corporate DB" field to the list 

           clientContext.ExecuteQuery();
        }
    }
}
 ```

3. Замените  `TODO5` указанным ниже кодом. Обратите внимание на указанные ниже особенности этого кода.

  - Класс **ListCreationInformation** похож на класс **ListItemCreationInformation**, который вы уже встречали в одной из предыдущих статей этой серии. Это "легковесный" класс, более подходящий для отправки информации из веб-приложения в SharePoint, чем полноценный класс **List**.


  - Существует много типов шаблонов списков, например тип Tasks для списка "список дел" и тип Events для календаря. Список **Local Employees** (Местные сотрудники) основан на самом простом типе Generic.


  - В свойстве **ListCreationInformation.Url** хранится URL-адрес списка, *относительный*  для хост-сайта. Указывая "Lists/LocalEmployees", код задает полный URL-адрес списка в виде https:// *{Домен_SharePoint}*  /hongkong/_layouts/15/start.aspx#/Lists/Local%20Employees.



 ```cs

ListCreationInformation listInfo = new ListCreationInformation();
listInfo.Title = "Local Employees";
listInfo.TemplateType = (int)ListTemplateType.GenericList;
listInfo.Url = "Lists/Local Employees";
List localEmployeesList = clientContext.Web.Lists.Add(listInfo);
 ```

4. Замените  `TODO6` указанным ниже кодом, который изменяет общедоступное имя поля (столбца) Title (Название) на Name (Имя). Это то, что вы делали на странице **List Settings** (Параметры списка), когда создавали список вручную.

 ```cs

Field field = localEmployeesList.Fields.GetByInternalNameOrTitle("Title");
field.Title = "Name";
field.Update();
 ```

5. Кроме того, вы вручную создали поле с именем **Added to Corporate DB** (Добавлен в корпоративную базу данных). Чтобы сделать это программным способом, добавьте указанный ниже код вместо `TODO7`. Обратите внимание на указанные ниже особенности этого кода.

  - Ключевые свойства этого поля задаются с помощью большого двоичного объекта XML. Это связано с архитектурой SharePoint: веб-сайты, списки, поля, типы содержимого и большая часть других типов компонентов SharePoint определяются в виде XML. В данном случае мы указываем для поля отображаемое имя, тип данных и имя, используемое по умолчанию.


  - Второй параметр указывает, должно ли отображаться поле в представлении списка, используемом по умолчанию. Мы присвоим ему значение **true**. 


  - Третий параметр можно использовать для определения того, к каким типам содержимого следует добавлять это поле. Если передать **DefaultValue**, это будет означать, что оно будет добавляться в тип содержимого списка, используемый по умолчанию.



 ```cs

localEmployeesList.Fields.AddFieldAsXml("<Field DisplayName='Added to Corporate DB'"
                                         +"Type='Boolean'>"
                                         + "<Default>FALSE</Default></Field>",
                                         true,
                                         AddFieldOptions.DefaultValue);
 ```

6. Вспомним, что по умолчанию поле **Added to Corporate DB** (Добавлен в корпоративную базу данных) имеет значение **No** (Нет), то есть false, но после добавления сотрудника в базу данных предприятия настраиваемая кнопка ленты в надстройке присваивает полю значение **Yes** (Да). Эта система отлично работает только если у пользователей нет возможности изменять значение поля вручную. Чтобы у пользователей гарантированно не было такой возможности, сделайте поле невидимым в формах создания и редактирования элементов в списке **Local Employees** (Местные сотрудники). Мы сделаем это, добавив два дополнительных атрибута в первый параметр, как показано ниже.

 ```cs

localEmployeesList.Fields.AddFieldAsXml("<Field DisplayName='Added to Corporate DB'"
                                         + " Type='Boolean'"
                                         + " ShowInEditForm='FALSE' "
                                         + " ShowInNewForm='FALSE'>"
                                         + "<Default>FALSE</Default></Field>",
                                         true,
                                         AddFieldOptions.DefaultValue);
 ```


    Весь метод  `CreateLocalEmployeesList` должен иметь указанный ниже вид.



 ```cs

private static void CreateLocalEmployeesList()
{
    using (var clientContext = sPContext.CreateUserClientContextForSPHost())
    {
        var query = from list in clientContext.Web.Lists
                    where list.Title == "Local Employees"
                    select list;
        IEnumerable<List> matchingLists = clientContext.LoadQuery(query);
        clientContext.ExecuteQuery();

        if (matchingLists.Count() == 0)
        {
            ListCreationInformation listInfo = new ListCreationInformation();
            listInfo.Title = "Local Employees";
            listInfo.TemplateType = (int)ListTemplateType.GenericList;
            listInfo.Url = "LocalEmployees";
            List localEmployeesList = clientContext.Web.Lists.Add(listInfo);

            Field field = localEmployeesList.Fields.GetByInternalNameOrTitle("Title");
            field.Title = "Name";
            field.Update();

            localEmployeesList.Fields.AddFieldAsXml("<Field DisplayName='Added to Corporate DB'" 
                                                    + " Type='Boolean'"
                                                   + " ShowInEditForm='FALSE' "
                                                   + " ShowInNewForm='FALSE'>"
                                                   + "<Default>FALSE</Default></Field>",
                                                    true,
                                                    AddFieldOptions.DefaultValue);
            clientContext.ExecuteQuery();
        }
    }
}
 ```


## Временное удаление настраиваемой кнопки из проекта

По техническим причинам, которые мы рассмотрим в следующей статье, созданную нами настраиваемую кнопку не удастся установить без изменений, если необходимо разместить ее на ленте списка, который развернут программным способом. Мы временно удалим ее из проекта, чтобы можно было протестировать код, выполняемый при первом запуске. Мы вернем ее в следующей статье.



В **обозревателе решений** в проекте **ChainStore** щелкните правой кнопкой мыши узел **AddEmployeeToCorpDB** и выберите пункт **Исключить из проекта**.




## Запрос разрешения на управление списками на хост-сайте

Так как теперь надстройка добавляет список на хост-сайт, а не только элементы в существующий список, нам необходимо расширить разрешения для надстройки с "Запись" до "Управление". Выполните указанные ниже действия.




1. В **обозревателе решений** в проекте **ChainStore** откройте файл AppManifest.xml.


2. Откройте вкладку **Разрешения**. Для поля **Область** оставьте значение "Интернет", а в поле **Разрешение** в раскрывающемся списке выберите пункт **Управление**.


3. Сохраните файл.



## Запуск надстройки и тестирование кода, выполняемого при первом запуске






1. Откройте страницу **Site Contents** (Содержание сайта) веб-сайта магазина в Гонконге *и удалите список **Local Employees** (Местные сотрудники).* 


2. Нажмите клавишу F5, чтобы развернуть и запустить вашу надстройку. Visual Studio размещает удаленное веб-приложение в IIS Express, а базу данных SQL  в SQL Express. Кроме того, он создает временную установку надстройки на вашем тестовом сайте SharePoint и сразу же запускает ее. Прежде чем откроется начальная страница надстройки, вам будет предложено предоставить необходимые для надстройки разрешения.


3. Когда откроется начальная страница надстройки, нажмите кнопку **Back to Site** (Вернуться на сайт) на размещенном в верхней части элементе управления хрома.


4. Перейдите на страницу **Site Contents** (Содержание сайта). На ней будет список **Local Employees** (Список сотрудников), так как код, выполняемый при первом запуске, добавил его.

    > **Примечание**
      > Если этого списка нет или у вас имеются другие свидетельства того, что код, выполняемый при первом запуске, не выполняется, то возможно, что при нажатии клавиши F5 таблица **Tenants** (Клиенты) не очищается. Самая распространенная причина этого заключается в том, что проект **ChainCorporateDB** больше не задан в качестве начального проекта в Visual Studio. См. примечание в верхней части данной статьи о том, как устранить эту проблему. Кроме того, убедитесь, что вы настроили базу данных так, чтобы она перестраивалась, как описано в разделе [Настройка Visual Studio для перестройки корпоративной базы данных при каждом сеансе отладки](give-your-provider-hosted-add-in-the-sharepoint-look-and-feel.md#Rebuild). 
5. Откройте список и добавьте в него элемент. Обратите внимание, что на новой форме элемента больше нет поля **Added to Corporate DB** (Добавлен в корпоративную базу данных), поэтому нет возможности задать его значение вручную. Это справедливо и для формы изменения элемента.

!\[Форма создания элемента списка "Локальные сотрудники". Поле "Добавлен в корпоративную базу данных" теперь отсутствует. Остались только поле имени и кнопки "ОК" и "Отмена".](images/3fdc6752-4184-4928-9423-0bc7c0206c62.PNG)





6. С помощью кнопки "Назад" в браузере вернитесь на начальную страницу надстройки.


7. Щелкните по значку с изображением шестеренки на элементе управления хрома в верхней части окна, а затем выберите **Параметры учетной записи**.


8. На странице **Учетные записи** нажмите кнопку **Показать версию надстройки**. Будет отображен номер версии **1.0.0.0**, так как код, выполняемый при первом запуске, изменил ее.

!\[Страница параметров учетной записи с номером версии 1.0.0.0.](images/4c6d82a7-7c40-4190-b7e3-1337275e1e60.PNG)





9. Чтобы завершить сеанс отладки, закройте окно браузера или остановите отладку в Visual Studio. При каждом нажатии клавиши F5 Visual Studio будет отзывать предыдущую версию надстройки и устанавливать ее последнюю версию.


10. Вы будете работать с этой надстройкой и решением Visual Studio и при изучении других статей, поэтому при перерывах в работе рекомендуется отзывать надстройку. В **обозревателе решений** щелкните проект правой кнопкой мыши и выберите пункт **Отозвать**.



## 
<a name="Nextsteps"> </a>

 В следующей статье вы узнаете, как вернуть в надстройку настраиваемую кнопку для ленты **Local Employee** (Местный сотрудник), когда развертывание списка выполняется программным путем: [Программное развертывание настраиваемой кнопки в надстройке, размещаемой у поставщика](programmatically-deploy-a-custom-button-in-the-provider-hosted-add-in.md)




