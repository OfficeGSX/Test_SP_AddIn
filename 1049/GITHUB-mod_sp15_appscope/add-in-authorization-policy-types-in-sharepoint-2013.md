---
title: Типы политик авторизации для надстроек в SharePoint 2013
ms.prod: SHAREPOINT
ms.assetid: 124879c7-a746-4c10-96a7-da76ad5327f0
---


# Типы политик авторизации для надстроек в SharePoint 2013
В этом разделе содержатся сведения о различных политиках авторизации для надстроек в SharePoint: политика только для надстроек, политика для надстроек и пользователей, политика только для пользователей. Представлены рекомендации по использованию политики только для надстроек.
Перед прочтением данной статьи, необходимо сначала ознакомиться с разделами  [Разрешения для надстроек в SharePoint 2013](add-in-permissions-in-sharepoint-2013.md) и [Поток маркеров контекста OAuth для надстроек в SharePoint](context-token-oauth-flow-for-sharepoint-add-ins.md).





## Общие сведения о типах политик авторизации надстроек
<a name="Overview"> </a>

В SharePoint применяются три типа политик авторизации.




- **Политика только для пользователей**. При ее использовании SharePoint проверяет только разрешения пользователя. SharePoint применяет эту политику, когда пользователь получает доступ непосредственно к ресурсам, не используя надстройку, например если пользователь впервые открывает домашнюю страницу веб-сайта SharePoint или получает доступ к API SharePoint из PowerShell.




- **Политика для пользователей и надстроек**. При использовании этой политики SharePoint проверяет разрешения как пользователя, так и надстройки. Авторизация успешна, только если текущий пользователь и надстройка имеют разрешения на выполнение необходимых действий.

    Например, эта политика используется, когда надстройке SharePoint необходимо получить доступ к ресурсам пользователя в SharePoint. Код в удаленных компонентах надстройки SharePoint должен быть реализован так, чтобы можно было выполнять вызовы для пользователей и надстроек к SharePoint.




- **Политика только для надстроек**. При использовании этой политики SharePoint проверяет только разрешения надстройки. Авторизация успешна, только если текущая надстройка имеет достаточно разрешений для выполнения необходимый действий, независимо от разрешений, имеющихся у текущего пользователя (если они имеются).

    Примером использования этой политики может служить надстройка для утверждения расходов. С ее помощью пользователи, которые не имеют возможности утверждать расходы меньше определенной суммы, могут выполнять такие действия. Дополнительные сведения см. в сценарии ниже. 



    > **Примечание**
    > Определенным API требуется пользовательский контекст, и они не могут выполняться при использовании политики только для надстроек. К ним относятся множество API, предназначенных для взаимодействия с Project Server 2013 и выполнения поисковых запросов. 

### Пример надстройки, в отношении которой применяется политика только для надстроек
<a name="Scenario"> </a>

Предположим, менеджер по продажам в Contoso Сергей покупает надстройку по предоставлению документов о расходах, в которой используется политика только для надстроек. При покупке надстройки Сергею предлагается разрешить ей работать с разрешениями более высокого уровня (надстройка может выполнять вызовы только для надстроек в SharePoint). Допустим, что Сергей предоставил надстройке такие разрешения. Затем он покупает достаточное количество лицензий надстройки для всех продавцов Contoso и устанавливает ее на веб-сайте SharePoint отдела продаж.



Вскоре продавцы начинают отправлять отчеты о расходах с помощью новой надстройки. Обычно продавцам не предоставляется возможность утверждать их собственные отчеты о расходах, но они могут это сделать с помощью надстройки для отчетов, сумма в которых не превышает 50 рублей. Сергей настроил автоматическое утверждение подобных отчетов. Надстройка автоматически назначает ему задачу по утверждению отчетов, сумма в которых меньше 50 рублей. Это можно реализовать, предоставив надстройке SharePoint разрешение на запись в список утвержденных расходов SharePoint. Но среди пользователей разрешение на запись в список имеется только у руководителей отдела кадров. Код в надстройке реализован так, что расходы в список добавляются с помощью вызова к SharePoint только для надстроек в том случае, если сумма расходов составляет меньше 50 рублей. Так как разрешения пользователя не проверяются, любые отчеты пользователя, не превышающие 50 рублей, автоматически добавляются в список утвержденных расходов, даже если у пользователя нет разрешения на запись в список.








### Получение надстройками разрешений на использование политики только для надстроек
<a name="Approve"> </a>

Чтобы получить возможность выполнять вызовы к SharePoint только для надстроек, в манифесте надстройки следует запросить разрешение на использование политики только для надстроек. Для этого добавьте атрибут **AllowAppOnlyPolicy** к элементу **AppPermissionRequests** и задайте для него значение **true**, как показано в примере кода ниже.



```XML

<AppPermissionRequests AllowAppOnlyPolicy="true">
    ...
</AppPermissionRequests>```


> **Примечание**
> Надстройки SharePoint ранее назывались "приложения для SharePoint". Для поддержания обратной совместимости схема манифеста приложения осталась прежней, поэтому строка "app" присутствует в большинстве имен элементов и атрибутов. 




Пользователю, устанавливающему надстройку, будет предложено утвердить этот запрос. Если надстройка запрашивает клиентские разрешения, то разрешить использование политики только для надстроек может только администратор клиента, поэтому только он может установить надстройку. Если надстройка не запрашивает никакие разрешения, область которых выше семейства веб-сайтов, то установить ее может администратор семейства веб-сайтов. Дополнительные сведения об областях разрешений см. в разделе  [Разрешения для надстроек в SharePoint 2013](add-in-permissions-in-sharepoint-2013.md).




### Выполнение надстройками вызовов только для надстроек
<a name="AppOnlyCalls"> </a>

Различие между вызовом к SharePoint только для надстроек и вызовом для пользователей и надстроек заключается в типе маркера доступа, который включен в вызов. В примере кода ниже показано, как создать и получить маркеры доступа для пользователей и надстроек и маркеры доступа только для надстроек в управляемом коде. Готовый код представлен в файле TokenHelper.cs (или с расширением VB), который Инструменты разработчика Office для Visual Studio автоматически добавляет в проект надстройки SharePoint в Visual Studio.



```cs

string contextTokenString = TokenHelper.GetContextTokenFromRequest(Request);
if (contextTokenString != null)
{
     //Get context token.
     SharePointContextToken contextToken =
          TokenHelper.ReadAndValidateContextToken(contextTokenString, Request.Url.Authority);
     Uri sharepointUrl = new Uri(Request.QueryString["SPHostUrl"]);

     //Get user+add-in access token.
     string accessToken =
          TokenHelper.GetAccessToken(contextToken, sharepointUrl.Authority).AccessToken;

      ClientContext clientContext =
           TokenHelper.GetClientContextWithAccessToken(sharepointUrl.ToString(), accessToken);

      //Do something. 
       ...

      //Get add-in-only access token.
       string addinOnlyAccessToken = 
            TokenHelper.GetAppOnlyAccessToken(contextToken.TargetPrincipalName, 
                              sharepointUrl.Authority, contextToken.Realm).AccessToken;
         //Do something.
         ...
}```


> **Примечание**
> В надстройках, которые не выполняют вызовы проверки подлинности OAuth (например, надстройки, написанные только на JavaScript и выполняющиеся в веб-надстройке), политика только для надстроек не может использоваться. Эти надстройки запрашивают разрешение, но не могут им воспользоваться, так как при этом им необходимо обрабатывать токен OAuth только для надстроек. Только надстройки с веб-приложениями, выполняющиеся вне среды SharePoint, могут создавать и обрабатывать маркеры только для надстроек. 




Как правило, чтобы сделать вызов, требуется наличие текущего пользователя. При использовании политики только для надстроек SharePoint создает пользователя SHAREPOINT\\APP наподобие существующего SHAREPOINT\\SYSTEM. Все запросы только для надстроек делаются от имени пользователя SHAREPOINT\\APP. Другого способа проверить подлинность, кроме использования профиля пользователя SHAREPOINT\\APP, не существует.




### Рекомендации по использованию политики только для надстроек
<a name="GuidelinesFor"> </a>

Поскольку вызовы только для надстроек позволяют эффективно повысить уровень прав пользователя, следует с осторожностью создавать надстройки, которые запрашивают такие разрешения. Вызовы должны использовать политики только для надстроек исключительно в указанных ниже случаях.




- Надстройке необходимо повысить уровень своих разрешений по сравнению с пользователем для выполнения определенного вызова (например, чтобы надстройка могла самостоятельно утвердить отчет о расходах).


- Надстройка не выполняется от имени любого пользователя (например, надстройка, выполняющая задачи по ночному обслуживанию библиотеки документов SharePoint.



## Дополнительные ресурсы
<a name="AR"> </a>


-  [Авторизация и проверка подлинности для надстроек в SharePoint 2013](authorization-and-authentication-of-sharepoint-add-ins.md)


-  [Разрешения для надстроек в SharePoint 2013](add-in-permissions-in-sharepoint-2013.md)


-  [Поток маркеров контекста OAuth для надстроек в SharePoint](context-token-oauth-flow-for-sharepoint-add-ins.md)


-  [Надстройки SharePoint](sharepoint-add-ins.md)


-  [Знакомство с созданием надстроек SharePoint с размещением у поставщика](get-started-creating-provider-hosted-sharepoint-add-ins.md)



