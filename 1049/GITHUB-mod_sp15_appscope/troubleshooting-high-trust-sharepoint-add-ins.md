---
title: Устранение неполадок надстроек с высоким уровнем доверия для SharePoint
ms.prod: SHAREPOINT
ms.assetid: f464c89e-f318-4051-8589-07cc6b34241f
---


# Устранение неполадок надстроек с высоким уровнем доверия для SharePoint
Описание решений некоторых проблем, возникающих, когда разрабатываются Надстройки SharePoint с высоким уровнем доверия.
В этой статье описывается инструмент Fiddler и предоставляются инструкции по решению некоторых характерных проблем.





## Использование средства Fiddler

С помощью бесплатного  [средства Fiddler](http://www.telerik.com/fiddler) можно захватывать HTTP-запросы, отправляемые удаленным компонентом вашей надстройки в SharePoint. Для этого [средства есть бесплатное расширение](https://github.com/andrewconnell/SPOAuthFiddlerExt), которое автоматически декодирует маркеры доступа в запросах.



Установив Fiddler на сервере веб-приложений, добавьте в файл web.config следующую разметку, чтобы запросы удаленного веб-приложения проходили через данный прокси-сервер. Таким образом вы сможете отследить трассировку Fiddler и целиком увидеть отклик SharePoint при возникновении ошибки.




> **Примечание**
> Если вы не используете Fiddler, обязательно удалите данную маркировку. В противном случае ваша надстройка не сможет выполнять HTTP-запросы. 






```XML

<system.net>
  <defaultProxy>
    <proxy usesystemdefault="False" bypassonlocal="False" proxyaddress="http://127.0.0.1:8888" />
  </defaultProxy>
</system.net>
```

Установив Fiddler, вы можете проверить заголовки ответов от SharePoint, включая GUID запроса. Данный GUID запроса  идентификатор корреляции, с помощью которого можно находить в журналах ошибки, связанные с этим запросом.




## Ошибка авторизации 401
<a name="UnauthorizedException"> </a>

Ошибка авторизации **401 Unauthorized** может возникать по нескольким причинам, когда надстройка с высоким уровнем доверия впервые обращается к SharePoint. Если вы используете клиентскую объектную модель (CSOM), ошибка выглядит следующим образом:



```cs

[WebException: The remote server returned an error: (401) Unauthorized.]
   System.Net.HttpWebRequest.GetResponse() +8515936
   Microsoft.SharePoint.Client.SPWebRequestExecutor.Execute() +178
   Microsoft.SharePoint.Client.ClientRequest.ExecuteQueryToServer(ChunkStringBuilder sb) +1427
   Microsoft.SharePoint.Client.ClientRequest.ExecuteQuery() +270
   Microsoft.SharePoint.Client.ClientRuntimeContext.ExecuteQuery() +146
   Microsoft.SharePoint.Client.ClientContext.ExecuteQuery() +666
   S2STestWeb.Default.Page_Load(Object sender, EventArgs e) in c:\\MyFiles\\HightrustTest\\HightrustTestWeb\\Default.aspx.cs:28
   System.Web.UI.Control.LoadRecursive() +71
   System.Web.UI.Page.ProcessRequestMain(Boolean includeStagesBeforeAsyncPoint, Boolean includeStagesAfterAsyncPoint) +3178```

Если вы используете файл TokenHelper и удостоверение Windows, код активации исключения имеет следующий вид:





```cs

ClientContext clientContext =
    TokenHelper.GetS2SClientContextWithWindowsIdentity(sharepointUrl, Request.LogonUserIdentity); 
clientContext.Load(clientContext.Web);
clientContext.ExecuteQuery();```

Чтобы устранить неполадку, в первую очередь необходимо с помощью отладчика Visual Studio проверить, успешно ли созданы маркер доступа и объект **ClientContext**. Если это так, необходимо проверить следующие возможности:



 **Возможные проблемы и их разрешение.**




- Не создан профиль для пользователя, который пытается получить доступ к удаленному веб-приложению. Создайте профиль пользователя.


- У вашей надстройки отсутствует разрешение на ресурсы, к которым вы собираетесь получить доступ. Откройте Командная консоль SharePoint и запустите следующий командлет Windows PowerShell. Переменная  `$web` представляет веб-сайт SharePoint, к которому вы пытаетесь получить доступ, а `$appPrincipal`  идентификатор надстройки. Дополнительные сведения см. в статье [Set-SPAppPrincipalPermission](http://technet.microsoft.com/ru-ru/library/jj219714%28v=office.15%29.aspx).
    ```
Set-SPAppPrincipalPermission -Site $web -AppPrincipal $appPrincipal -Scope Site -Right FullControl```

- Ваше веб-приложение принимает анонимные запросы. Это значит, что в маркере доступа отсутствует действующее удостоверение пользователя. Проверьте, отключен ли анонимный доступ в IIS для корневого каталога вашего удаленного веб-приложения. Это также можно проверить, выполнив отладку удаленного веб-приложения и проверив значение **Request.LogonUserIdentity** файла default.aspx (с расширением CS или VB), чтобы убедиться, что пользователь не анонимный.


- Цифровой сертификат не был добавлен в хранилище доверенных сертификатов. Обязательно выполните процедуры, описанные в статье  [Упаковка и публикация надстроек с высоким уровнем доверия для SharePoint](package-and-publish-high-trust-sharepoint-add-ins.md).



## Различные ошибки авторизации, связанные с SSL и доменами
<a name="DomainRelatedErrors"> </a>

Авторизации может препятствовать несовпадение доменных имен в файлах конфигурации и регистрационных формах. Следующие четыре значения должны полностью совпадать:




- **Домен надстройки**, который указывается при регистрации Надстройка SharePoint в AppRegNew.aspx.


- Домен, в котором регистрируется сертификат безопасности удаленного веб-приложения.


- Часть значения **StartPage**, относящаяся к домену, в файле AppManifest.xml.


- Часть URL-адресов, относящаяся к доменам, всех приемников событий, указанных в AppManifest.xml.


В связи с этим обратите внимание на следующее.




- Если ваше Надстройка SharePoint содержит удаленный компонент, использующий какой-либо другой порт, чем 443, вам необходимо явным образом включить порт как часть домена во всех четырех местах, например  `MarketingServer:3333`. (Необходимо использовать протокол HTTPS, порт по умолчанию для которого  443.)


- Домен должен быть указан во встроенном коде значения **StartPage** (и URL-адресе каждого приемника событий) файла AppManifest.xml до упаковки надстройки. Если для упаковки надстройки вы используете мастер **публикации** в Visual Studio, вам будет предложен домен и Инструменты разработчика Office для Visual Studio вставит его для вас в значение **StartPage** (вместо маркера `~remoteWebUrl`, который используется при отладке). Но если вы не используете мастер **публикации**, вам необходимо вручную заменить маркер на домен (и протокол), например  `https://MarketingServer` или `https://MarketingServer:3333`.



## Ошибка выполнения с сообщением об отсутствии сертификата с таким серийным номером
<a name="DomainRelatedErrors"> </a>

Если вы уверены в правильности серийного номера сертификата в файле web.config, и сертификат отображается в **хранилище сертификатов Windows**, то, скорее всего, в файле web.config в серийном номере есть дополнительный скрытый символ. Такое бывает, если серийный номер скопирован и вставлен из **консоли управления (MMC)**. Полностью удалите значение серийного номера из файла web.config и повторно введите его *вручную*  .




