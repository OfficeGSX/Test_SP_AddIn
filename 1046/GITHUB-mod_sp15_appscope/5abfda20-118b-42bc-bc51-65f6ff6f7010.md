
# Etapa 2: Configurar envio notificações em um aplicativos hospedados pelo provedor para o SharePoint
Saiba como criar notificações por push de um provedor hospedado Suplementos do SharePoint usando os receptores de evento remoto.
 * **Aplica-se a:*** 
  
    
    

 **Neste artigo**
  
    
    
 [Pré-requisitos para configurar as notificações por push](#Step2_Configurepush_Prerequisites)
  
    
    
 [Criar notificações por push em um aplicativo hospedado em provedor para SharePoint usando um receptor de evento remoto](5abfda20-118b-42bc-bc51-65f6ff6f7010.md#Step2_Configurepush_Createnotification)
  
    
    
 [Próximas etapas](#Step2_Configurepush_Nextstep)
  
    
    
 [Recursos adicionais](#Step2_Configurepush_Addres)
This is the second article in a three-part series that shows how to create a companion mobile app for SharePoint. For more information, see  [Como: criar um aplicativo móvel de complementar para um aplicativo do SharePoint](d124d2ea-f772-495c-941c-6507d6da2c17.md).
  
    
    

In this step, you will add a remote event receiver to an Suplemento do SharePoint (created in  [Etapa 1: Criar um aplicativo hospedado pelo provedor lista baseada no SharePoint 2013](e79ee2e7-0a80-4858-a311-c4f1f8d72a56.md)) to send push notifications to the mobile app. Using the Microsoft Push Notification Service (MPNS), Windows Phone apps can receive notifications through the events triggered on Suplementos do SharePoint. The phone app doesn't have to poll the server for changes to, for example, the items in a list on which the phone app is based. The app can be registered to receive notifications from the server, and an event receiver can initiate a notification and send it to the receiving app for handling. The push notification is relayed to Windows Phone devices by MPNS.Suplementos do SharePoint pode ser apps hospedado no SharePoint ou hospedados pelo provedor. Cada uma dessas tem maneiras diferentes de manipulação de eventos, dependendo de seus recursos de hospedagem. Aplicativos hospedados pelo provedor de manipular eventos usando os receptores de evento remoto e os aplicativos hospedados pelo SharePoint tratar eventos usando manipuladores de eventos, como soluções do lado do servidor tradicional . Porque você está trabalhando em um aplicativo hospedado em provedor neste procedimento, você criará um receptor de evento remoto para lidar com eventos no aplicativo.Notificações de push serão enviadas aos aplicativos móveis, que são registrados para receber notificações. As notificações por push são acionadas por uma ação que ocorre em um objeto do SharePoint especificado. Se você tiver um aplicativo hospedado no SharePoint, você pode criar um receptor de evento para enviar notificações por push. Para obter mais informações, consulte  [Como: configurar e usar as notificações por push nos aplicativos do SharePoint 2013 para Windows Phone](http://msdn.microsoft.com/library/68fa2138-86d9-4e35-9c7c-5cd292087b80%28Office.15%29.aspx#BKMK_ServerSideSolution).
## Pré-requisitos para configurar as notificações por push
<a name="Step2_Configurepush_Prerequisites"> </a>

Para concluir este procedimento, você precisará do seguinte:
  
    
    

- Uma instalação local do Microsoft Visual Studio 2012.
    
  
- Uma instalação local do Office Developer Tools para Visual Studio 2012.
    
  
- Uma instalação local do Web implantar 3.5, que pode ser baixado da  [Web implantar 3.5](http://go.microsoft.com/fwlink/?LinkId=257328).
    
  
- Uma instalação local do SharePoint 2013. Além disso, a instalação deve ser configurada para usar OAuth se desejar executar um receptor de evento, por exemplo, testar e depurá-lo.
    
    > [!OBSERVAçãO]
      > SharePoint 2013 já está configurado para usar OAuth, se você estiver testando o aplicativo em um site de destino que foi criado da definição de Site do desenvolvedor. (Você pode criar um site de Web no SharePoint 2013 a Administração Central).

### Principais conceitos saber para notificações de push
<a name="Step2_ConfigurePushNotificationinSPApp_CoreConcepts"> </a>

Antes de começar esses procedimentos, você deve ter um basic compreensão de quais Suplementos do SharePoint são e como hospedado em provedor ou diferem de aplicativos hospedados pelo SharePoint. Você também deve compreender os conceitos fundamentais sobre como lidar com eventos em Suplementos do SharePoint. Os tópicos na tabela 1 devem fornecer esse entendimento.
  
    
    

**Tabela 1. Principais conceitos para manipular eventos nos aplicativos para SharePoint**


|**Título do artigo**|**Descrição**|
|:-----|:-----|
| [Suplementos do SharePoint](cd1eda9e-8e54-4223-93a9-a6ea0d18df70.md) <br/> |Saiba como você pode usar o novo modelo de aplicativo em SharePoint 2013 para criar aplicativos, que são pequenas e fácil de usar soluções para usuários finais. <br/> |
| [Aspectos importantes do Add-in SharePoint arquitetura e desenvolvimento cenário](ae96572b-8f06-4fd3-854f-fc312f7f2d88.md) <br/> |Saiba mais sobre os aspectos de sua arquitetura, incluindo o ciclo de vida, as opções de interface do usuário, o sistema de implantação, o sistema de segurança e opções de hospedagem de aplicativos e modelo de Suplementos do SharePoint. <br/> |
| [Escolha os padrões para desenvolver e hospedar o Add-in do SharePoint](05ce5435-0a03-4ddc-976b-c33b08d03457.md) <br/> |Saiba mais detalhes sobre as diferentes maneiras que você pode hospedar Suplementos do SharePoint. <br/> |
| [Lidar com eventos no SharePoint Add-ins](c050d056-8548-4496-a053-016779d723d9.md) <br/> |Saiba mais sobre os diferentes tipos de eventos que você pode manipular em um Suplemento do SharePoint e como implementá-las. <br/> |
   

## Criar notificações por push em um aplicativo hospedado em provedor para SharePoint usando um receptor de evento remoto
<a name="Step2_Configurepush_Createnotification"> </a>

This section contains two steps. First, you add a .cs file to the Suplemento do SharePoint project created in  [Etapa 1: Criar um aplicativo hospedado pelo provedor lista baseada no SharePoint 2013](e79ee2e7-0a80-4858-a311-c4f1f8d72a56.md). Second, you add a remote event receiver to the Visual Studio 2012 project to your app solution. For more information, see  [Como: criar um receptor de eventos para um aplicativo do SharePoint](f20a0476-e3f7-4f1b-b692-2ec893245b85.md).
  
    
    

### Para criar as classes de gerenciamento de notificações por push


1. In **Solution Explorer**, choose the node that represents the project (named SupportCenterWeb if you follow the naming convention used in these procedures). This is the project that you created in [Etapa 1: Criar um aplicativo hospedado pelo provedor lista baseada no SharePoint 2013](e79ee2e7-0a80-4858-a311-c4f1f8d72a56.md).
    
  
2. No menu **projeto**, escolha **Adicionar classe**. A caixa de diálogo **Adicionar Novo Item** aparece com o modelo de c# **classe** que já está selecionado.
    
  
3. Especifique PushNotification.cs como o nome do arquivo e escolha **Adicionar**. O arquivo de classe é adicionado à solução e aberto para edição.
    
  
4. Substitua o conteúdo do arquivo com o código a seguir.
    
  ```cs
  
namespace SupportCenterWeb
{
    class PushNotification
    {
        public PushNotificationResponse PushToast(PushNotificationSubscriber subscriber, string toastTitle, string toastMessage, string toastParam, ToastIntervalValuesEnum intervalValue)
        {
            // Construct toast notification message from parameter values.
            string toastNotification = "<?xml version=\\"1.0\\" encoding=\\"utf-8\\"?>" +
            "<wp:Notification xmlns:wp=\\"WPNotification\\">" +
               "<wp:Toast>" +
                    "<wp:Text1>" + toastTitle + "</wp:Text1>" +
                    "<wp:Text2>" + toastMessage + "</wp:Text2>" +
                    "<wp:Param>" + toastParam + "</wp:Param>" +
               "</wp:Toast> " +
            "</wp:Notification>";

            return SendPushNotification(NotificationTypeEnum.Toast, subscriber, toastNotification, (int)intervalValue);
        }

        public PushNotificationResponse PushRaw(PushNotificationSubscriber subscriber, string rawMessage, RawIntervalValuesEnum intervalValue)
        {
            return SendPushNotification(NotificationTypeEnum.Raw, subscriber, rawMessage, (int)intervalValue);
        }

        private PushNotificationResponse SendPushNotification(NotificationTypeEnum notificationType, PushNotificationSubscriber subscriber, string message, int intervalValue)
        {
            // Create HTTP Web Request object.
            string subscriptionUri = subscriber.ServiceToken;
            HttpWebRequest sendNotificationRequest = (HttpWebRequest)WebRequest.Create(subscriptionUri);

            // MPNS expects a byte array, so convert message accordingly.
            byte[] notificationMessage = Encoding.Default.GetBytes(message);
            
            // Set the notification request properties.
            sendNotificationRequest.Method = WebRequestMethods.Http.Post;
            sendNotificationRequest.ContentLength = notificationMessage.Length;
            sendNotificationRequest.ContentType = "text/xml";
            sendNotificationRequest.Headers.Add("X-MessageID", Guid.NewGuid().ToString());

            switch (notificationType)
            {
                case NotificationTypeEnum.Tile:
                    sendNotificationRequest.Headers.Add("X-WindowsPhone-Target", "token");
                    break;
                case NotificationTypeEnum.Toast:
                    sendNotificationRequest.Headers.Add("X-WindowsPhone-Target", "toast");
                    break;
                case NotificationTypeEnum.Raw:
                    // A value for the X-WindowsPhone-Target header is not specified for raw notifications.
                    break;
            }            

            sendNotificationRequest.Headers.Add("X-NotificationClass", intervalValue.ToString());

            // Merge byte array payload with headers.
            using (Stream requestStream = sendNotificationRequest.GetRequestStream())
            {
                requestStream.Write(notificationMessage, 0, notificationMessage.Length);
            }

            string statCode = string.Empty;
            PushNotificationResponse notificationResponse;

            try
            {
                // Send the notification and get the response.
                HttpWebResponse response = (HttpWebResponse)sendNotificationRequest.GetResponse();
                statCode = Enum.GetName(typeof(HttpStatusCode), response.StatusCode);

                // Create PushNotificationResponse object.
                notificationResponse = new PushNotificationResponse((int)intervalValue, subscriber.ServiceToken);
                notificationResponse.StatusCode = statCode;
                foreach (string header in WP7Constants.WP_RESPONSE_HEADERS)
                {
                    notificationResponse.Properties[header] = response.Headers[header];
                }                
            }
            catch (Exception ex)
            {
                statCode = ex.Message;
                notificationResponse = new PushNotificationResponse((int)intervalValue, subscriber.ServiceToken);
                notificationResponse.StatusCode = statCode;
            }

            return notificationResponse;
        }
    }

    internal static class WP7Constants
    {
        internal static readonly string[] WP_RESPONSE_HEADERS = 
            {
                "X-MessageID",
                "X-DeviceConnectionStatus",
                "X-SubscriptionStatus",
                "X-NotificationStatus"
            };
    }

    public enum TileIntervalValuesEnum
    {
        ImmediateTile = 1,
        Delay450SecondsTile = 11,
        Delay900SecondsTile = 21,
    }

    public enum ToastIntervalValuesEnum
    {
        ImmediateToast = 2,
        Delay450SecondsToast = 12,
        Delay900SecondsToast = 22,
    }

    public enum RawIntervalValuesEnum
    {
        ImmediateRaw = 3,
        Delay450SecondsRaw = 13,
        Delay900SecondsRaw = 23
    }

    public enum NotificationTypeEnum
    {
        Tile = 1,
        Toast = 2,
        Raw = 3
    }

    /// <summary>
    /// Object used for returning notification request results.
    /// </summary>
    class PushNotificationResponse
    {
        private DateTime timestamp;
        private int notificationIntervalValue;
        private string statusCode = string.Empty;
        private string serviceToken;
        private Dictionary<string, string> properties;

        public PushNotificationResponse(int numericalIntervalValue, string srvcToken)
        {
            timestamp = DateTime.UtcNow;
            notificationIntervalValue = numericalIntervalValue;
            serviceToken = srvcToken;
            properties = new Dictionary<string, string>();
        }

        public DateTime TimeStamp
        {
            get { return timestamp; }
        }

        public int NotificationIntervalValue
        {
            get { return notificationIntervalValue; }
        }

        public string StatusCode
        {
            get { return statusCode; }
            set { statusCode = value; }
        }

        public string ServiceToken
        {
            get { return serviceToken; }
        }

        public Dictionary<string, string> Properties
        {
            get { return properties; }
        }
    }
}
  ```

5. Salve o arquivo.
    
  
Nesse código, os métodos **PushToast** e **PushRaw** levam argumentos de parâmetro apropriados para o tipo de dado de notificação para enviar, processar desses argumentos e então chamar o método **SendPushNotification**, que faz o trabalho de envio da notificação usando o serviço de notificação por Push da Microsoft. (Nesse código de exemplo, um método de envio de notificações de blocos não foi implementado.) A classe **PushNotificationResponse** é um mecanismo para encapsular o resultado recebido da solicitação de notificação. Aqui, a classe adiciona algumas informações ao objeto (cast como um objeto **HttpWebResponse** ) retornadas pelo método **GetResponse** do objeto **HttpWebRequest**. O receptor de evento que você criar no procedimento a seguir usa esta classe **PushNotificationResponse** para atualizar uma lista de resultados de notificações no servidor.
  
    
    
In this section, you extend an Suplemento do SharePoint by adding a remote event receiver and enabling it to handle events that occur to list items in the app. Now create a remote event receiver class that will be triggered when an item is added to the list in your app. By doing this, you will send push notifications to devices that have been registered to receive them. (You will bind this event receiver to the Job list that is created in the Suplemento do SharePoint in  [Etapa 1: Criar um aplicativo hospedado pelo provedor lista baseada no SharePoint 2013](e79ee2e7-0a80-4858-a311-c4f1f8d72a56.md).)
  
    
    

### Para adicionar um receptor de evento remoto para notificações de push


1. No Visual Studio, abra **Solution Explorer** e, em seguida, escolha o nó do projeto de aplicativo.
    
  
2. Na barra de menus, escolha **Project**, **Adicionar Novo Item**.
    
  
3. No painel de **Modelos instalados**, escolha o **Office / SharePoint** nó.
    
  
4. No painel de **modelos**, escolha o modelo do **Receptor de evento remoto**.
    
  
5. Na caixa **nome**, deixe o nome padrão (SupportCenterRER) e escolha o botão **Adicionar**.
    
  
6. No **que tipo de receptor de evento você deseja?** lista, escolha **Eventos de Item de lista**.
    
  
7. No **qual item deve ser a origem do evento?** lista, selecione **a lista de casos (existe \\Cases)**.
    
  
8. Na lista de **lidar com os eventos a seguir**, escolha **um item que está sendo adicionado** e, em seguida, escolha o botão **Concluir**.
    
    Um serviço web é adicionado ao aplicativo web para manipular o evento remoto que você especificou. Um receptor de evento remoto é adicionado para o Suplemento do SharePoint e referencia o serviço da web e os eventos de item de lista de duas no arquivo Elements XML do receptor.
    
  
9. Para adicionar a funcionalidade do receptor de evento remoto, adicione o código a seguir no arquivo de código para o serviço do receptor de evento remoto (ou seja, SupportCenterRER.svc.cs).
    
  ```
  
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using Microsoft.SharePoint.Client;
using Microsoft.SharePoint.Client.EventReceivers;

namespace SupportCenterWeb
{
    public class SupportCenterRER : IRemoteEventService
    {
        public SPRemoteEventResult ProcessEvent(SPRemoteEventProperties properties)
        {
            SPRemoteEventResult result = new SPRemoteEventResult();

            using (ClientContext clientContext = TokenHelper.CreateRemoteEventReceiverClientContext(properties))
            {
                if (clientContext != null)
                {
                    //Custom Code
                }
            }

            return result;
        }

        public void ProcessOneWayEvent(SPRemoteEventProperties properties)
        {
            using (ClientContext clientContext = TokenHelper.CreateRemoteEventReceiverClientContext(properties))
            {
                if (clientContext != null)
                {
                    

                    //Send Push Notification to relevant subscribers
                    Web web = clientContext.Web;

                    PushNotificationSubscriberCollection pushSubscribers = web.PushNotificationSubscribers;
                    PushNotification pushNotification = new PushNotification();
                    int itemID = properties.ItemEventProperties.ListItemId;
                    string listTitle = properties.ItemEventProperties.ListTitle;
                    ListItem listItem = web.Lists.GetByTitle(listTitle).GetItemById(itemID);

                    clientContext.Load(listItem);
                    clientContext.Load(pushSubscribers);
                    clientContext.ExecuteQuery();

                    if (listItem["AssignedTo"] == null)
                        return;
                    // multi user field
                    string assignedUser = (listItem["AssignedTo"] as FieldUserValue[])[0].LookupValue;                    

                    PushNotificationResponse pushResponse = null;

                    foreach (PushNotificationSubscriber ps in pushSubscribers)
                    {
                        // add filter logic here for sending notification to specific user
                        string notificationTitle = string.Empty;

                        if (properties.EventType == SPRemoteEventType.ItemAdded)
                            notificationTitle = "New case assigned: ";
                        else if (properties.EventType == SPRemoteEventType.ItemUpdated)
                            notificationTitle = "A case assigned to you has been updated: ";
                        else
                            notificationTitle = "A case assigned to you has been removed: ";

        // Send a toast notification to be displayed on subscribed phones on which the app is not running.
                        pushResponse = pushNotification.PushToast(ps, notificationTitle, listItem["Title"].ToString(), string.Empty, ToastIntervalValuesEnum.ImmediateToast);
                        UpdateNotificationResultsList(clientContext, web, assignedUser, pushResponse);

// Also send a raw notification to be displayed on subscribed phones on which the app is running when the item is added.
                        pushResponse = pushNotification.PushRaw(ps, notificationTitle + listItem["Title"].ToString(), RawIntervalValuesEnum.ImmediateRaw);
                        UpdateNotificationResultsList(clientContext, web, assignedUser, pushResponse);
                    }
                }
            }
        }

        private void UpdateNotificationResultsList(ClientContext context, Web web, string subscriberName, PushNotificationResponse pushResponse)
        {
            List notificationsList = web.Lists.GetByTitle("Notifications");
            context.Load(notificationsList);
            context.ExecuteQuery();

            if (notificationsList == null)
                return;

            try
            {
                ListItem resultItem = notificationsList.AddItem(new ListItemCreationInformation());
                resultItem["Title"] = subscriberName;
                resultItem["NotificationTime"] = pushResponse.TimeStamp;
                resultItem["StatusCode"] = pushResponse.StatusCode;
                resultItem["ServiceToken"] = pushResponse.ServiceToken;

                StringBuilder builder = new StringBuilder();
                foreach (string key in pushResponse.Properties.Keys)
                {
                    builder.AppendFormat("{0}: {1}; ", key, pushResponse.Properties[key]);
                }
                resultItem["Headers"] = builder.ToString();

                resultItem["IntervalValue"] = pushResponse.NotificationIntervalValue;
                resultItem.Update();
                context.ExecuteQuery();
            }
            catch
            {
                // Could log here if adding list item fails.
            }
        }
    }
}

  ```

10. Salve o arquivo.
    
  
11. Altere a propriedade de **Url do Site** do projeto Suplemento do SharePoint para a URL do sistema local.
    
    Você pode desenvolver receptores de evento remoto e receptores de eventos do aplicativo somente nos sistemas locais. Depois de implantar os receptores, eles podem ser usados em sistemas remotos.
    
  
12. Now you can deploy your app to the SharePoint site. For more information, see  [Implantando e instalando os suplementos do SharePoint: métodos e opções](d15a74a7-3c10-485a-9885-7ef11aaa0d90.md).
    
  
Nesse código, depois que um item é adicionado à lista à qual o receptor de evento estiver ligado, as notificações por push são enviadas para os assinantes que foram registrados para receber notificações.
  
    
    
A notificação de proposta é exibida em telefones inscritos (se o aplicativo de telefone para o qual destina-se a notificação não está sendo executado) e a mensagem exibida será truncada se ela for maior que aproximadamente 41 caracteres. Notificações de brutas em MPNS estão limitadas a 1024 bytes (1 quilobyte). (O número exato de caracteres que pode ser enviado depende do tipo de codificação usado, como UTF-8.) Notificações de blocos também estão sujeitos a limitações de tamanho. Grandes quantidades de dados não podem ser enviadas usando qualquer um dos tipos de notificação. O melhor uso dessas notificações não é como um mecanismo para transferência de dados, mas como uma maneira de enviar mensagens curtas para inscrito telefones para que certas ações podem ser realizadas no telefone. Essas ações, como atualização de uma lista no telefone com dados do servidor, podem envolver os maiores volumes de dados, dependendo do design do aplicativo do Windows Phone.
  
    
    

## Próximas etapas
<a name="Step2_Configurepush_Nextstep"> </a>

In the next step,  [Etapa 3: Criar um aplicativo móvel e registrar para notificações de push](ca56ac7f-f7cf-4fab-b2b7-66abb814fac2.md), you learn how to create a companion mobile app for the SharePoint app.
  
    
    

## Recursos adicionais
<a name="Step2_Configurepush_Addres"> </a>


-  [Como: criar um aplicativo móvel de complementar para um aplicativo do SharePoint](d124d2ea-f772-495c-941c-6507d6da2c17.md)
    
  
-  [Desenvolver suplementos do SharePoint](71ddde4b-fac4-4d8c-aa2e-524f9c2c4c99.md)
    
  
-  [Etapa 3: Criar um aplicativo móvel e registrar para notificações de push](ca56ac7f-f7cf-4fab-b2b7-66abb814fac2.md)
    
  
-  [Crie aplicativos do Windows Phone que acessam o SharePoint 2013](http://msdn.microsoft.com/library/36681335-f772-4499-8445-f94481bc18e7%28Office.15%29.aspx)
    
  
-  [Como: configurar e usar as notificações por push nos aplicativos do SharePoint 2013 para Windows Phone](http://msdn.microsoft.com/library/68fa2138-86d9-4e35-9c7c-5cd292087b80%28Office.15%29.aspx)
    
  
