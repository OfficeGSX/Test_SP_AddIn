
# 步驟 2： 設定推入 SharePoint 在提供者裝載的應用程式中的通知
了解如何建立提供者主控SharePoint Add-ins使用的遠端事件接收器的推入通知。
 * **適用於:*** 
  
    
    

 **本文內容**
  
    
    
 [設定推入通知的必要條件](#Step2_Configurepush_Prerequisites)
  
    
    
 [建置 SharePoint 使用的遠端事件接收器的提供者主控應用程式中的推入通知](5abfda20-118b-42bc-bc51-65f6ff6f7010.md#Step2_Configurepush_Createnotification)
  
    
    
 [後續步驟](#Step2_Configurepush_Nextstep)
  
    
    
 [其他資源](#Step2_Configurepush_Addres)
This is the second article in a three-part series that shows how to create a companion mobile app for SharePoint. For more information, see  [如何： 建立 sharepoint 的同一系列文件行動應用程式的應用程式](d124d2ea-f772-495c-941c-6507d6da2c17.md).
  
    
    

In this step, you will add a remote event receiver to an SharePoint Add-in (created in  [步驟 1： 在 SharePoint 2013 中建立一個清單為基礎提供者裝載應用程式](e79ee2e7-0a80-4858-a311-c4f1f8d72a56.md)) to send push notifications to the mobile app. Using the Microsoft Push Notification Service (MPNS), Windows Phone apps can receive notifications through the events triggered on SharePoint Add-ins. The phone app doesn't have to poll the server for changes to, for example, the items in a list on which the phone app is based. The app can be registered to receive notifications from the server, and an event receiver can initiate a notification and send it to the receiving app for handling. The push notification is relayed to Windows Phone devices by MPNS.SharePoint Add-ins可以 SharePoint 主控或提供者主控應用程式。這每一項具有不同處理事件根據其架設的方法。提供者主控應用程式處理事件使用的遠端事件接收器，以及 SharePoint 主控應用程式處理事件使用事件處理常式，如傳統用戶端解決方案所示。因為您使用此程序中的提供者主控應用程式，您將建立來處理事件的應用程式的遠端事件接收器。註冊以接收通知的行動應用程式傳送推入通知。發生於指定的 SharePoint 物件的動作所觸發的推入通知。如果您有 SharePoint 裝載的應用程式，您可以建立事件接收器傳送推入通知。如需詳細資訊，請參閱 ＜  [操作方法： 設定及在 SharePoint 2013 應用程式中使用 Windows Phone 推入通知](http://msdn.microsoft.com/library/68fa2138-86d9-4e35-9c7c-5cd292087b80%28Office.15%29.aspx#BKMK_ServerSideSolution)。
## 設定推入通知的必要條件
<a name="Step2_Configurepush_Prerequisites"> </a>

若要完成此程序，您將需要下列各項：
  
    
    

- Microsoft Visual Studio 2012本機安裝。
    
  
- Visual Studio 2012 Office 開發人員工具本機安裝。
    
  
- Web 部署 3.5，其中您可以下載 [Web 部署 3.5](http://go.microsoft.com/fwlink/?LinkId=257328)從本機安裝。
    
  
- SharePoint 2013本機安裝。此外，安裝必須設定為使用 OAuth，如果您要執行事件接收器，例如、 測試及偵錯它。
    
    > **注意事項**
      > SharePoint 2013已設定為使用 OAuth，如果您正在測試在目標網站的開發人員網站定義當初用來建立該應用程式。(您可以在SharePoint 2013管理中心建立這類網站)。

### 若要知道的推入通知的核心概念
<a name="Step2_ConfigurePushNotificationinSPApp_CoreConcepts"> </a>

開始這些程序之前，您應該會有的哪些SharePoint Add-ins已瞭解和方式的提供者主控採用基本或 SharePoint 主控應用程式不同。您也應該了解如何處理中SharePoint Add-ins事件的基本概念。表 1 中的各項主題應該會，了解。
  
    
    

**表 1。Sharepoint 處理事件的應用程式的核心概念**


|**文章標題**|**描述**|
|:-----|:-----|
| [SharePoint Add-ins](cd1eda9e-8e54-4223-93a9-a6ea0d18df70.md) <br/> |了解如何使用新的應用程式模型中的全部SharePoint 2013建立應用程式]，亦即小型、 易於使用解決方案的使用者。 <br/> |
| [重要方面之 SharePoint 增益集架構設計和開發入門](ae96572b-8f06-4fd3-854f-fc312f7f2d88.md) <br/> |了解SharePoint 增益集相關的模型和其架構，包括應用程式代管選項、 使用者介面選項、 部署系統、 安全性系統和生命週期方面。 <br/> |
| [選擇如何開發和裝載您 SharePoint 的增益集的模式](05ce5435-0a03-4ddc-976b-c33b08d03457.md) <br/> |了解更多詳細可控SharePoint Add-ins的不同方式。 <br/> |
| [處理事件中 SharePoint 增益集](c050d056-8548-4496-a053-016779d723d9.md) <br/> |深入了解不同類型的事件，您可以處理SharePoint Add-in及如何實作它們。 <br/> |
   

## 建置 SharePoint 使用的遠端事件接收器的提供者主控應用程式中的推入通知
<a name="Step2_Configurepush_Createnotification"> </a>

This section contains two steps. First, you add a .cs file to the SharePoint Add-in project created in  [步驟 1： 在 SharePoint 2013 中建立一個清單為基礎提供者裝載應用程式](e79ee2e7-0a80-4858-a311-c4f1f8d72a56.md). Second, you add a remote event receiver to the Visual Studio 2012 project to your app solution. For more information, see  [如何： 建立 SharePoint 事件接收者的應用程式](f20a0476-e3f7-4f1b-b692-2ec893245b85.md).
  
    
    

### 若要建立類別來管理推入通知


1. In **Solution Explorer**, choose the node that represents the project (named SupportCenterWeb if you follow the naming convention used in these procedures). This is the project that you created in [步驟 1： 在 SharePoint 2013 中建立一個清單為基礎提供者裝載應用程式](e79ee2e7-0a80-4858-a311-c4f1f8d72a56.md).
    
  
2. 在 [ **專案**] 功能表上選擇 [ **新增類別**]。[ **新增項目**] 對話方塊會出現在已選取 [C# **類別**範本。
    
  
3. 指定PushNotification.cs為檔案的名稱，然後選擇 [ **新增]**。類別檔案新增解決方案和開啟進行編輯。
    
  
4. 取代下列程式碼之檔案的內容。
    
  ```cs
  
namespace SupportCenterWeb
{
    class PushNotification
    {
        public PushNotificationResponse PushToast(PushNotificationSubscriber subscriber, string toastTitle, string toastMessage, string toastParam, ToastIntervalValuesEnum intervalValue)
        {
            // Construct toast notification message from parameter values.
            string toastNotification = "<?xml version=\\"1.0\\" encoding=\\"utf-8\\"?>" +
            "<wp:Notification xmlns:wp=\\"WPNotification\\">" +
               "<wp:Toast>" +
                    "<wp:Text1>" + toastTitle + "</wp:Text1>" +
                    "<wp:Text2>" + toastMessage + "</wp:Text2>" +
                    "<wp:Param>" + toastParam + "</wp:Param>" +
               "</wp:Toast> " +
            "</wp:Notification>";

            return SendPushNotification(NotificationTypeEnum.Toast, subscriber, toastNotification, (int)intervalValue);
        }

        public PushNotificationResponse PushRaw(PushNotificationSubscriber subscriber, string rawMessage, RawIntervalValuesEnum intervalValue)
        {
            return SendPushNotification(NotificationTypeEnum.Raw, subscriber, rawMessage, (int)intervalValue);
        }

        private PushNotificationResponse SendPushNotification(NotificationTypeEnum notificationType, PushNotificationSubscriber subscriber, string message, int intervalValue)
        {
            // Create HTTP Web Request object.
            string subscriptionUri = subscriber.ServiceToken;
            HttpWebRequest sendNotificationRequest = (HttpWebRequest)WebRequest.Create(subscriptionUri);

            // MPNS expects a byte array, so convert message accordingly.
            byte[] notificationMessage = Encoding.Default.GetBytes(message);
            
            // Set the notification request properties.
            sendNotificationRequest.Method = WebRequestMethods.Http.Post;
            sendNotificationRequest.ContentLength = notificationMessage.Length;
            sendNotificationRequest.ContentType = "text/xml";
            sendNotificationRequest.Headers.Add("X-MessageID", Guid.NewGuid().ToString());

            switch (notificationType)
            {
                case NotificationTypeEnum.Tile:
                    sendNotificationRequest.Headers.Add("X-WindowsPhone-Target", "token");
                    break;
                case NotificationTypeEnum.Toast:
                    sendNotificationRequest.Headers.Add("X-WindowsPhone-Target", "toast");
                    break;
                case NotificationTypeEnum.Raw:
                    // A value for the X-WindowsPhone-Target header is not specified for raw notifications.
                    break;
            }            

            sendNotificationRequest.Headers.Add("X-NotificationClass", intervalValue.ToString());

            // Merge byte array payload with headers.
            using (Stream requestStream = sendNotificationRequest.GetRequestStream())
            {
                requestStream.Write(notificationMessage, 0, notificationMessage.Length);
            }

            string statCode = string.Empty;
            PushNotificationResponse notificationResponse;

            try
            {
                // Send the notification and get the response.
                HttpWebResponse response = (HttpWebResponse)sendNotificationRequest.GetResponse();
                statCode = Enum.GetName(typeof(HttpStatusCode), response.StatusCode);

                // Create PushNotificationResponse object.
                notificationResponse = new PushNotificationResponse((int)intervalValue, subscriber.ServiceToken);
                notificationResponse.StatusCode = statCode;
                foreach (string header in WP7Constants.WP_RESPONSE_HEADERS)
                {
                    notificationResponse.Properties[header] = response.Headers[header];
                }                
            }
            catch (Exception ex)
            {
                statCode = ex.Message;
                notificationResponse = new PushNotificationResponse((int)intervalValue, subscriber.ServiceToken);
                notificationResponse.StatusCode = statCode;
            }

            return notificationResponse;
        }
    }

    internal static class WP7Constants
    {
        internal static readonly string[] WP_RESPONSE_HEADERS = 
            {
                "X-MessageID",
                "X-DeviceConnectionStatus",
                "X-SubscriptionStatus",
                "X-NotificationStatus"
            };
    }

    public enum TileIntervalValuesEnum
    {
        ImmediateTile = 1,
        Delay450SecondsTile = 11,
        Delay900SecondsTile = 21,
    }

    public enum ToastIntervalValuesEnum
    {
        ImmediateToast = 2,
        Delay450SecondsToast = 12,
        Delay900SecondsToast = 22,
    }

    public enum RawIntervalValuesEnum
    {
        ImmediateRaw = 3,
        Delay450SecondsRaw = 13,
        Delay900SecondsRaw = 23
    }

    public enum NotificationTypeEnum
    {
        Tile = 1,
        Toast = 2,
        Raw = 3
    }

    /// <summary>
    /// Object used for returning notification request results.
    /// </summary>
    class PushNotificationResponse
    {
        private DateTime timestamp;
        private int notificationIntervalValue;
        private string statusCode = string.Empty;
        private string serviceToken;
        private Dictionary<string, string> properties;

        public PushNotificationResponse(int numericalIntervalValue, string srvcToken)
        {
            timestamp = DateTime.UtcNow;
            notificationIntervalValue = numericalIntervalValue;
            serviceToken = srvcToken;
            properties = new Dictionary<string, string>();
        }

        public DateTime TimeStamp
        {
            get { return timestamp; }
        }

        public int NotificationIntervalValue
        {
            get { return notificationIntervalValue; }
        }

        public string StatusCode
        {
            get { return statusCode; }
            set { statusCode = value; }
        }

        public string ServiceToken
        {
            get { return serviceToken; }
        }

        public Dictionary<string, string> Properties
        {
            get { return properties; }
        }
    }
}
  ```

5. 儲存該文件。
    
  
在這段程式碼， **PushToast**和 **PushRaw**方法會採用指定類型的通知傳送且處理這些引數，則呼叫 **SendPushNotification**方法，傳送通知使用 Microsoft 推入通知服務的運作適當的參數引數。(在此範例程式碼傳送並排顯示通知的方法有不已實作)。 **PushNotificationResponse**類別是一種連線機制封裝接收通知要求的結果。在這裡，類別新增一些資訊 **HttpWebRequest**物件的 **GetResponse**方法所傳回的物件 (cast 為 **HttpWebResponse**物件)。在下列程序中建立，事件接收器來更新通知結果清單中的伺服器上使用此 **PushNotificationResponse**類別。
  
    
    
In this section, you extend an SharePoint Add-in by adding a remote event receiver and enabling it to handle events that occur to list items in the app. Now create a remote event receiver class that will be triggered when an item is added to the list in your app. By doing this, you will send push notifications to devices that have been registered to receive them. (You will bind this event receiver to the Job list that is created in the SharePoint Add-in in  [步驟 1： 在 SharePoint 2013 中建立一個清單為基礎提供者裝載應用程式](e79ee2e7-0a80-4858-a311-c4f1f8d72a56.md).)
  
    
    

### 若要新增的推入通知的遠端事件接收器


1. 在 Visual Studio 中，開啟 [ **方案總管**] 中，然後按應用程式專案的節點。
    
  
2. 功能表列上，選擇 [ **專案**， **新增項目**]。
    
  
3. 在 **已安裝的範本**] 窗格中，選擇 [ **Office / SharePoint**節點。
    
  
4. 在 [ **範本**] 窗格中，選擇 [ **遠端事件接收器**範本。
    
  
5. 在 [ **名稱**] 方塊中，保留預設名稱 (SupportCenterRER)，然後按 [ **新增**] 按鈕。
    
  
6. 在 **您需要何種類型的事件接收器？**清單中，選擇 **清單項目事件**。
    
  
7. 在 **項目應為事件來源？**清單中，選擇 **的情況下清單 (所 \\Cases)**。
    
  
8. 在 **處理下列事件**] 清單中，選擇 **要新增的項目**，，然後選擇 [ **完成**] 按鈕。
    
    Web 服務會新增至 web 應用程式，以處理所指定的遠端事件。遠端事件接收器新增到SharePoint Add-in和 web 服務及受話方的 Elements.xml 檔案中的兩個清單項目事件會參照。
    
  
9. 若要將功能新增至遠端事件接收器，新增下列程式碼之服務的遠端事件接收器 (亦即 SupportCenterRER.svc.cs) 程式碼檔案中。
    
  ```
  
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using Microsoft.SharePoint.Client;
using Microsoft.SharePoint.Client.EventReceivers;

namespace SupportCenterWeb
{
    public class SupportCenterRER : IRemoteEventService
    {
        public SPRemoteEventResult ProcessEvent(SPRemoteEventProperties properties)
        {
            SPRemoteEventResult result = new SPRemoteEventResult();

            using (ClientContext clientContext = TokenHelper.CreateRemoteEventReceiverClientContext(properties))
            {
                if (clientContext != null)
                {
                    //Custom Code
                }
            }

            return result;
        }

        public void ProcessOneWayEvent(SPRemoteEventProperties properties)
        {
            using (ClientContext clientContext = TokenHelper.CreateRemoteEventReceiverClientContext(properties))
            {
                if (clientContext != null)
                {
                    

                    //Send Push Notification to relevant subscribers
                    Web web = clientContext.Web;

                    PushNotificationSubscriberCollection pushSubscribers = web.PushNotificationSubscribers;
                    PushNotification pushNotification = new PushNotification();
                    int itemID = properties.ItemEventProperties.ListItemId;
                    string listTitle = properties.ItemEventProperties.ListTitle;
                    ListItem listItem = web.Lists.GetByTitle(listTitle).GetItemById(itemID);

                    clientContext.Load(listItem);
                    clientContext.Load(pushSubscribers);
                    clientContext.ExecuteQuery();

                    if (listItem["AssignedTo"] == null)
                        return;
                    // multi user field
                    string assignedUser = (listItem["AssignedTo"] as FieldUserValue[])[0].LookupValue;                    

                    PushNotificationResponse pushResponse = null;

                    foreach (PushNotificationSubscriber ps in pushSubscribers)
                    {
                        // add filter logic here for sending notification to specific user
                        string notificationTitle = string.Empty;

                        if (properties.EventType == SPRemoteEventType.ItemAdded)
                            notificationTitle = "New case assigned: ";
                        else if (properties.EventType == SPRemoteEventType.ItemUpdated)
                            notificationTitle = "A case assigned to you has been updated: ";
                        else
                            notificationTitle = "A case assigned to you has been removed: ";

        // Send a toast notification to be displayed on subscribed phones on which the app is not running.
                        pushResponse = pushNotification.PushToast(ps, notificationTitle, listItem["Title"].ToString(), string.Empty, ToastIntervalValuesEnum.ImmediateToast);
                        UpdateNotificationResultsList(clientContext, web, assignedUser, pushResponse);

// Also send a raw notification to be displayed on subscribed phones on which the app is running when the item is added.
                        pushResponse = pushNotification.PushRaw(ps, notificationTitle + listItem["Title"].ToString(), RawIntervalValuesEnum.ImmediateRaw);
                        UpdateNotificationResultsList(clientContext, web, assignedUser, pushResponse);
                    }
                }
            }
        }

        private void UpdateNotificationResultsList(ClientContext context, Web web, string subscriberName, PushNotificationResponse pushResponse)
        {
            List notificationsList = web.Lists.GetByTitle("Notifications");
            context.Load(notificationsList);
            context.ExecuteQuery();

            if (notificationsList == null)
                return;

            try
            {
                ListItem resultItem = notificationsList.AddItem(new ListItemCreationInformation());
                resultItem["Title"] = subscriberName;
                resultItem["NotificationTime"] = pushResponse.TimeStamp;
                resultItem["StatusCode"] = pushResponse.StatusCode;
                resultItem["ServiceToken"] = pushResponse.ServiceToken;

                StringBuilder builder = new StringBuilder();
                foreach (string key in pushResponse.Properties.Keys)
                {
                    builder.AppendFormat("{0}: {1}; ", key, pushResponse.Properties[key]);
                }
                resultItem["Headers"] = builder.ToString();

                resultItem["IntervalValue"] = pushResponse.NotificationIntervalValue;
                resultItem.Update();
                context.ExecuteQuery();
            }
            catch
            {
                // Could log here if adding list item fails.
            }
        }
    }
}

  ```

10. 儲存該文件。
    
  
11. 變更的 **網站 Url**屬性SharePoint Add-in專案的本機系統的 url。
    
    您可以開發的遠端事件接收器和只能在本機系統上的應用程式事件接收器。部署這些接收器之後，他們可以使用遠端系統上。
    
  
12. Now you can deploy your app to the SharePoint site. For more information, see  [部署及安裝 SharePoint 增益集： 方法與選項](d15a74a7-3c10-485a-9885-7ef11aaa0d90.md).
    
  
在這段程式碼，項目新增到清單中要繫結事件接收器後, 推入通知傳送給已註冊以接收通知的訂閱者。
  
    
    
吐司通知會顯示在已訂閱的電話 (如果對象與通知的電話應用程式未執行)，並超過大約 41 個字元時，會無條件捨去所顯示的訊息。MPNS 中的原始通知限於 1024 位元組 (1 kb)。(完全可傳送的字元數目取決於所使用，例如 utf-8 編碼類型)。並排顯示通知也包含受制於大小限制。無法使用任何通知類型傳送大量的資料。利用這些通知不是一種連線機制傳輸的資料，以，但將傳送至的簡短訊息的方式訂閱電話，讓電話上採取的特定動作。這些動作，例如重新整理資料從伺服器中的電話上的清單可能會涉及大幅資料，根據 Windows Phone 應用程式的設計。
  
    
    

## 後續步驟
<a name="Step2_Configurepush_Nextstep"> </a>

In the next step,  [步驟 3： 建立行動應用程式和登錄的推入通知](ca56ac7f-f7cf-4fab-b2b7-66abb814fac2.md), you learn how to create a companion mobile app for the SharePoint app.
  
    
    

## 其他資源
<a name="Step2_Configurepush_Addres"> </a>


-  [如何： 建立 sharepoint 的同一系列文件行動應用程式的應用程式](d124d2ea-f772-495c-941c-6507d6da2c17.md)
    
  
-  [開發 SharePoint 的增益集](71ddde4b-fac4-4d8c-aa2e-524f9c2c4c99.md)
    
  
-  [步驟 3： 建立行動應用程式和登錄的推入通知](ca56ac7f-f7cf-4fab-b2b7-66abb814fac2.md)
    
  
-  [建置存取 SharePoint 2013 的 Windows Phone 應用程式](http://msdn.microsoft.com/library/36681335-f772-4499-8445-f94481bc18e7%28Office.15%29.aspx)
    
  
-  [操作方法： 設定及在 SharePoint 2013 應用程式中使用 Windows Phone 推入通知](http://msdn.microsoft.com/library/68fa2138-86d9-4e35-9c7c-5cd292087b80%28Office.15%29.aspx)
    
  
